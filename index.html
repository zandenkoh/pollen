<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeta AI</title>
    <link rel="icon" type="image/png" href="https://s3.amazonaws.com/static.graphemica.com/glyphs/i500s/000/010/545/original/01B5-500x500.png?1275328666">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f9f8f6;
            color: #1a202c;
            min-height: 100vh;
            display: flex;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }

        svg {
            width: 20px;
            height: 20px;
            transition: transform 0.2s ease;
        }

        .markdown-body {
            font-size: 18px;
            line-height: 1.8;
            font-family: 'Roboto', sans-serif;
            color: #1a202c;
        }

        .markdown-body h1 {
            font-size: 1.75em;
            font-weight: 700;
            margin-bottom: 0.75em;
            color: #2d3748;
        }

        .markdown-body h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 0.6em;
        }

        .markdown-body h3 {
            font-size: 1.25em;
            font-weight: 500;
            margin-bottom: 0.5em;
        }

        .message.ai p {
            margin-bottom: 1.25em;
        }

        .markdown-body ul,
        .markdown-body ol {
            margin: 1em 0 1em 2em;
            padding-left: 1em;
        }

        .markdown-body li {
            margin-bottom: 0.75em;
        }

        .markdown-body blockquote {
            border-left: 4px solid #c9c8c6;
            background-color: transparent;
            padding: 1em 1.5em;
            font-style: italic;
            color: #000;
            margin: 1.5em 0;
            border-radius: 0;
        }

        .markdown-body a {
            color: #000;
            font-weight: 500;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 30px;
            background: #e0dfdd;
        }

        .markdown-body a:hover {
            opacity: 0.6;
        }

        /* Syntax Highlighting for Code Blocks */
        .markdown-body pre {
            background: #fff;
            margin: 15px 0;
            padding: 1em;
            border-radius: 8px;
            position: relative;
            font-size: 0.9em;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .markdown-body pre::-webkit-scrollbar {
            background-color: #fff;
        }

        .markdown-body code {
            background: #fff;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* Dark mode */
        body.dark-mode .message.ai {
            background-color: #2d3748;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        body.dark-mode .markdown-body {
            color: #e2e8f0;
        }

        body.dark-mode .markdown-body h1 {
            color: #e2e8f0;
        }

        body.dark-mode .markdown-body blockquote {
            border-left-color: #8E54E9;
            background-color: #2d3748;
            color: #a0aec0;
        }

        body.dark-mode .markdown-body pre {
            background: #2d3748;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .markdown-body code {
            background: #4b5563;
        }

        .code-copy-btn {
            position: absolute;
            right: 15px;
            background: transparent;
            border: none;
            border-radius: 7px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            color: #666;
        }

        .code-copy-btn:hover {
            background-color: #e5e5e5;
            color: #000;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #sidebar {
            width: 260px;
            height: 100vh;
            background-color: #fefefe;
            border-right: 0 solid #e5e7eb;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow-y: hidden;
            user-select: none;
        }

        body.dark-mode #sidebar {
            background-color: #2d3748;
            border-right-color: #4b5563;
        }

        #sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        #sidebar-header {
            display: flex;
            gap: 8px;
            /* Space between buttons */
            padding: 12px 16px;
            justify-content: flex-start;
            /* Align buttons to the left */
        }

        .ellipsis-btn {
            background: none;
            border: 0 solid #d1d5db;
            border-radius: 6px;
            padding: 4px;
            cursor: pointer;
            color: #64748b;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
        }

        .ellipsis-btn:hover {
            outline: 1px solid #d1d5db;
        }

        #clearHistoryBtn,
        #sortToggleBtn {
            background: none;
            border: 0 solid #d1d5db;
            border-radius: 50%;
            padding: 10px;
            cursor: pointer;
            color: #64748b;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
        }

        #clearHistoryBtn:hover,
        #sortToggleBtn:hover {
            color: #000;
            background-color: #d8dce0;
        }

        body.dark-mode #clearHistoryBtn,
        body.dark-mode #sortToggleBtn {
            border-color: #4b5563;
            color: #a0aec0;
        }

        body.dark-mode #clearHistoryBtn:hover,
        body.dark-mode #sortToggleBtn:hover {
            background-color: #4b5563;
        }

        .history-section-header.pinned {
            color: #000;
            /* Light yellow for pinned section */
            font-weight: 500;
        }

        body.dark-mode .history-section-header.pinned {
            background-color: #92400e;
            /* Darker amber for pinned in dark mode */
        }

        body.dark-mode #sidebar-header {
            border-bottom-color: #4b5563;
        }

        #historyList {
            flex: 1;
            overflow-y: scroll;
            padding: 8px;
        }

        .history-section {
            margin-bottom: 10px;
        }

        .history-section-header {
            padding: 10px;
            background-color: transparent;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 700;
            margin-top: 15px;
            margin-bottom: 0;
        }

        body.dark-mode .history-section-header {
            background-color: #4b5563;
        }

        .history-section-content {
            display: none;
        }

        .history-section-content.open {
            display: block;
        }

        .history-item {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #0f172a;
            transition: background-color 0.2s ease;
        }

        .history-item:hover {
            background-color: #f0f0f0;
        }

        .history-item.active {
            background-color: #e3e3e3;
            /* Highlight active chat */
        }

        body.dark-mode .history-item {
            color: #e2e8f0;
        }

        body.dark-mode .history-item:hover {
            background-color: #4b5563;
        }

        .delete-chat {
            display: none;
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
        }

        .history-item:hover .delete-chat {
            display: block;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        nav {
            padding: 16px 24px;
            background-color: transparent;
            border-bottom: 0 solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            position: absolute;
            width: 100%;
            z-index: 10;
            user-select: none;
        }

        body.dark-mode nav {
            background-color: #2d3748;
            border-bottom-color: #4b5563;
        }

        nav h1 {
            font-size: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #4776E6, #8E54E9);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: bold;
            cursor: pointer;
        }

        .nav-buttons {
            display: flex;
            gap: 0;
        }

        .nav-buttons button {
            background: none;
            border: none;
            padding: 13px;
            cursor: pointer;
            color: #0a0a0a;
            border-radius: 50%;
            width: 43px;
            height: 43px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        body.dark-mode .nav-buttons button {
            color: #a0aec0;
        }

        .nav-buttons button:hover {
            background-color: #e9e8e7;
        }

        body.dark-mode .nav-buttons button:hover {
            background-color: #4b5563;
        }

        .group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .tooltip {
            position: absolute;
            background-color: #fff;
            box-shadow: 0 0 2 0 rgb(0 0 0 0.5);
            color: #000;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
            top: calc(100% + 6px);
            /* Position below the button with spacing */
            left: 50%;
            /* Start at the horizontal center of the button */
            transform: translateX(-50%);
            /* Shift left by half its width to center */
            white-space: nowrap;
            /* Prevent text wrapping */
            z-index: 10;
            /* Ensure it appears above other elements */
        }

        .group:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        #chatContainer {
            height: calc(50vh - 50px);
            top: 0;
            padding: 0px calc(50% - 375px);
            overflow-y: scroll;
            overflow-x: hidden;
            background-color: #f9f8f6;

        }

        body.dark-mode #chatContainer {
            background-color: #1f2937;
        }

        .message {
            margin-bottom: 34px;
            padding: 10px 20px;
            border-radius: 30px;

            position: relative;
            font-size: 17px;

        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message:hover {}

        .message.user {
            background-color: #fff;
            border: 1px solid #eaeaea;
            margin-left: auto;
            max-width: 60%;
            width: fit-content;
            margin-bottom: 50px;
            animation: fadeIn 0.3s ease-in;
            display: flex;
            align-items: center;
        }

        .message.user .message-actions {
            position: absolute;
            bottom: -50px;
            padding: 15px;
            width: 100%;
            right: 0;
            display: none;
            border-box: box-sizing;

            flex-direction: row;
            align-items: center;
            justify-content: right;
        }

        .message.user:hover .message-actions {
            display: flex;
        }

        .message.ai {
            background-color: transparent;
            max-width: 100%;
            font-size: 20px;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.8;
        }

        .message-actions {
            display: flex;
            margin-top: 8px;
            gap: 8px;
        }

        .message.ai:hover .message-actions {
            display: flex;
        }

        .message.ai.editable .markdown-body {
            border: 1px solid #d1d5db;
            padding: 5px;
            border-radius: 4px;
        }

        body.dark-mode .message.ai.editable .markdown-body {
            border-color: #4b5563;
        }

        .message-actions button {
            background: none;
            border: none;
            padding: 6px;
            border-radius: 50%;
            cursor: pointer;
            color: #64748b;
            transition: background-color 0.2s ease;
        }

        .message-actions button:hover {
            background-color: #e5e7eb;
            border-radius: 6px;
        }

        .message-actions svg {
            width: 16px;
            height: 16px;
        }

        body.dark-mode .message.user {
            background-color: #4b5563;
        }

        body.dark-mode .message.ai {
            background-color: #2d3748;
        }

        .message.ai:hover .message-actions {
            display: flex;
        }

        .message-actions button {
            background: none;
            border: none;
            padding: 6px;
            cursor: pointer;
            color: #64748b;
        }

        body.dark-mode .message-actions button {
            color: #a0aec0;
        }

        .message-actions button:hover {
            background-color: #e5e7eb;
            border-radius: 6px;
        }

        body.dark-mode .message-actions button:hover {
            background-color: #4b5563;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #64748b;
            border-radius: 50%;
            animation: blink 1.4s infinite both;
        }

        body.dark-mode .typing-dot {
            background-color: #a0aec0;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 0.2;
            }

            20% {
                opacity: 1;
            }
        }

        footer {
            padding: 0;
            background-color: #f9f8f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            bottom: 0;
            width: 100%;
            max-height: 400px;
            min-height: 100px;
        }

        body.dark-mode footer {
            background-color: #2d3748;
        }

        .input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 750px;
            background: #fefefe;
            /*box-shadow: 0px 0px 3px 0px rgba(0, 0, 0, 0.1);*/
            border: 2px solid #f0f0f0;
            border-radius: 25px;
            padding: 0 8px;
            font-family: 'Roboto';
            gap: 0;
            padding: 15px 16px 18px 16px;
            transition: 0.1s ease-in-out;
            user-select: none;
        }

        .input-container:hover {
            border: 2px solid #eaeaea;
        }

        .input-container:focus-within {
            box-shadow: 0px 1px 3px 0px rgba(0, 0, 0, 0.08);
            border: 2px solid #d8d8d8;
        }

        body.dark-mode .input-container {
            background: #2d3748;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        #messageInput {
            width: 100%;
            padding: 0;
            border: none;
            line-height: 1.5;
            border-radius: 8px;
            font-size: 18px;
            color: #444;
            resize: none;
            min-height: 25px;
            max-height: 200px;
            background-color: transparent;
            outline: none;
            font-family: 'Roboto';
            margin-bottom: 0;
        }

        #messageInput::-webkit-scrollbar {
            width: 0;
        }

        body.dark-mode #messageInput {
            color: #e2e8f0;
        }

        #messageInput::placeholder {
            color: #94a3b8;
        }

        body.dark-mode #messageInput::placeholder {
            color: #a0aec0;
        }

        .inside-input-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            height: 35px;
            width: 100%;
            margin: 0;
            padding: 8px 0;
            align-items: middle;
        }

        .input-actions {
            display: flex;
            justify-content: flex-end;
            /* Align buttons to the right */
            gap: 8px;
            padding: 0 0;
            /* Add some spacing */
        }

        .input-actions button {
            border: 1px solid #eaeaea;
            background: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .input-actions button:hover {
            background-color: #f0f0f0;
        }

        #searchBtn {
            width: fit-content;
            border-radius: 30px;
            padding: 0 12px;
            gap: 7px;
            font-size: 15px;
            color: #555;
            position: relative;
        }

        .input-actions #searchBtn.active {
            background-color: #ebebeb;
            /* Light blue to indicate active state */
            border-color: #d4d4d4;
            /* Blue border */
            color: #222;
            font-weight: 600;
        }

        body.dark-mode .input-actions #searchBtn.active {
            background-color: #4b5e8e;
            /* Darker blue for dark mode */
            border-color: #8E54E9;
            /* Purple border */
            color: #8E54E9;
            /* Purple text/icon */
        }

        #searchBtn svg {
            width: 17px;
            height: 17px;
            color: #555;
        }

        body.dark-mode .input-actions button {
            background: #4b5563;
            color: #e2e8f0;
        }

        body.dark-mode .input-actions button:hover {
            background-color: #6b7280;
        }

        #sendBtn {
            background: #000;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            transition: background-color 0.2s ease;
        }

        #sendBtn:hover {
            opacity: 0.8;
        }

        #micBtn.recording {
            background-color: #dc2626;
        }

        .footer-info {
            text-align: center;
            font-size: 13px;
            color: #999;
            margin: 10px 0;
            user-select: none;
        }

        body.dark-mode .footer-info {
            color: #a0aec0;
        }

        #scrollToBottomBtn {
            position: absolute;
            bottom: 100%;
            right: 26px;
            background: #f1f4f9;
            color: #666;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease;
        }

        body.dark-mode #scrollToBottomBtn {
            background: #4b5563;
            color: #e2e8f0;
        }

        #scrollToBottomBtn:hover {
            opacity: 0.8;
        }

        /* Settings Modal Base Styles */
        #settingsModal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.3);
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
            user-select: none;
            backdrop-filter: blur(3px);
        }

        .settings-modal-container {
            background-color: #fff;
            border-radius: 30px;
            width: 800px;
            /* Slightly wider for better grid layout */
            max-width: 90vw;
            height: 440px;
            /* Slightly taller for content */
            max-height: 90vh;
            display: flex;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        body.dark-mode .settings-modal-container {
            background-color: #1e2937;
        }

        /* Sidebar Styles */
        .settings-sidebar {
            width: 220px;
            background-color: #fff;
            padding: 24px;
            display: flex;
            flex-direction: column;
            border-right: 0 solid #e2e8f0;
            border-radius: 16px 0 0 16px;
        }

        body.dark-mode .settings-sidebar {
            background-color: #17212b;
            border-right-color: #334155;
        }

        .settings-sidebar .settings-sidebar h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #1e293b;
        }

        body.dark-mode .settings-sidebar h2 {
            color: #e2e8f0;
        }

        .settings-tabs {
            list-style: none;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .settings-tabs .tab {
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 400;
            color: #444;
            cursor: pointer;
            border-radius: 13px;
            transition: all 0.2s ease;
        }

        .settings-tabs .tab:hover {
            background-color: #f1f0ee;
            color: #1e293b;
        }

        .settings-tabs .tab.active {
            background-color: #f1f0ee;
            color: #000;
        }

        body.dark-mode .settings-tabs .tab {
            color: #94a3b8;
        }

        body.dark-mode .settings-tabs .tab:hover {
            background-color: #334155;
            color: #e2e8f0;
        }

        body.dark-mode .settings-tabs .tab.active {
            background-color: #60a5fa;
        }

        /* Content Area Styles */
        .settings-content {
            flex: 1;
            padding: 44px 20px;
            overflow-y: auto;
            background-color: #fff;
            border-radius: 0 16px 16px 0;
        }

        body.dark-mode .settings-content {
            background-color: #1e2937;
        }

        .tab-content {
            display: none;
        }

        .tab-content::-webkit-scrollbar {
            width: 0;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1e293b;
        }

        body.dark-mode .tab-content h3 {
            color: #e2e8f0;
        }

        /* General Label and Input Styles */
        .tab-content label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 16px;
            width: 100%;
            border-box: box-sizing;
        }

        body.dark-mode .tab-content label {
            color: #dbdbdb;
        }

        /* Toggle Switch Styles */
        .tab-content input[type="checkbox"] {
            appearance: none;
            width: 48px;
            height: 24px;
            background-color: #dbdbdb;
            border-radius: 9999px;
            /* Fully rounded */
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
            order: 1;
            margin-left: auto;
        }

        .tab-content input[type="checkbox"]:checked {
            background-color: #0a0a0a;
        }

        body.dark-mode .tab-content input[type="checkbox"] {
            background-color: #64748b;
        }

        body.dark-mode .tab-content input[type="checkbox"]:checked {
            background-color: #60a5fa;
        }

        .tab-content input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background-color: #fff;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.2s ease;
        }

        .tab-content input[type="checkbox"]:checked::before {
            transform: translateX(24px);
        }

        /* Theme Selection Grid */
        #appearance .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 8px;
            margin-bottom: 20px;
        }

        #appearance h3 {
            font-size: 17px;
        }

        .theme-grid label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            background-color: #fff;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            color: #444;
            color: #475569;
            text-align: center;
            border: 1px solid #e7e5e4;
        }

        .theme-grid label svg {
            width: 20px;
            height: 20px;
        }

        .theme-grid input[type="radio"] {
            display: none;
        }

        .theme-grid input[type="radio"]:checked+label {
            background-color: #f0efed;
            border: 1px solid #e7e5e4;
            color: #000;
        }

        /* Dark mode adjustments */
        body.dark-mode .theme-grid label {
            background-color: #475569;
            /* Darker gray for dark mode */
            color: #94a3b8;
        }

        body.dark-mode .theme-grid input[type="radio"]:checked+label {
            background-color: #60a5fa;
            /* Lighter blue for dark mode */
            outline: 2px solid #3b82f6;
            /* Slightly darker outline */
            color: #fff;
        }

        /* Customize Response Grid */
        #customize .response-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 0;
        }

        /* Base style for response-grid label - slightly darker background */
        .response-grid label {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: start;
            padding: 14px;
            background-color: #fff;
            border: 1px solid #e7e5e4;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0;
        }

        /* Hide the radio inputs */
        .response-grid input[type="radio"] {
            display: none;
        }

        /* Style for the label when its corresponding radio is checked */
        .response-grid input[type="radio"]:checked+label {
            background-color: #f0efed;
            color: #000;
            border: 1px solid #e7e5e4;
        }

        /* Style for inner span and p */
        .response-grid .response-option span {
            font-size: 14px;
            font-weight: 500;
        }

        .response-grid .response-option p {
            font-size: 12px;
            margin: 0px 0;
        }

        /* Dark mode adjustments */
        body.dark-mode .response-grid label {
            background-color: #475569;
            /* Darker gray for dark mode */
            color: #94a3b8;
        }

        body.dark-mode .response-grid input[type="radio"]:checked+label {
            background-color: #60a5fa;
            /* Lighter blue for dark mode */
            outline: 2px solid #3b82f6;
            /* Slightly darker outline */
            color: #fff;
        }

        body.dark-mode .response-grid input[type="radio"]:checked+label span,
        body.dark-mode .response-grid input[type="radio"]:checked+label p {
            color: #fff;
        }

        /* Grid layout (unchanged from your original) */
        .response-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .response-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Other Input Styles */
        .tab-content select,
        .tab-content input[type="range"],
        .tab-content input[type="number"],
        .tab-content textarea {
            width: 100%;
            max-width: 320px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 8px;
            background-color: #fff;
            color: #1e293b;
        }

        body.dark-mode .tab-content select,
        body.dark-mode .tab-content input[type="range"],
        body.dark-mode .tab-content input[type="number"],
        body.dark-mode .tab-content textarea {
            border-color: #475569;
            background-color: #1e2937;
            color: #d1d5db;
        }

        .tab-content input[type="range"] {
            height: 8px;
            background: #d1d5db;
            border-radius: 4px;
        }

        .tab-content input[type="range"]::-webkit-slider-thumb {
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        .tab-content input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        body.dark-mode .tab-content input[type="range"] {
            background: #64748b;
        }

        body.dark-mode .tab-content input[type="range"]::-webkit-slider-thumb,
        body.dark-mode .tab-content input[type="range"]::-moz-range-thumb {
            background: #60a5fa;
        }

        #custom-instructions-container {
            display: none;
            /* Hidden by default, toggled via JS */
            margin-top: 16px;
            padding: 16px;
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        #custom-instructions-container label {
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 8px;
            display: block;
            letter-spacing: 0.2px;
        }

        #customInstructionsInput {
            width: 100%;
            /* Full width of container */
            box-sizing: border-box;
            /* Ensures padding doesnâ€™t overflow width */
            padding: 12px 14px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(145deg, #ffffff, #f7fafc);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.02);
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            color: #1e293b;
            line-height: 1.5;
            height: 90px;
            /* Fixed height instead of min/max */
            resize: none;
            /* Disable resizing */
            outline: none;
            transition: box-shadow 0.2s ease, transform 0.1s ease;
            position: relative;
        }

        #customInstructionsInput:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }

        #customInstructionsInput::placeholder {
            color: #94a3b8;
            font-style: italic;
            opacity: 0.8;
        }

        #saveCustomInstructionsBtn {
            padding: 8px 18px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }

        #saveCustomInstructionsBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        #saveCustomInstructionsBtn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Dark mode styles */
        body.dark-mode #custom-instructions-container {
            background-color: #2d3748;
            border-color: #4b5563;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }

        body.dark-mode #custom-instructions-container label {
            color: #e2e8f0;
        }

        body.dark-mode #customInstructionsInput {
            background: linear-gradient(145deg, #2d3748, #1e2937);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.1);
            color: #e2e8f0;
        }

        body.dark-mode #customInstructionsInput:focus {
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        body.dark-mode #customInstructionsInput::placeholder {
            color: #94a3b8;
        }

        body.dark-mode #saveCustomInstructionsBtn {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
        }

        body.dark-mode #saveCustomInstructionsBtn:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        body.dark-mode #saveCustomInstructionsBtn:active {
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #custom-instructions-container {
                padding: 12px;
            }

            #customInstructionsInput {
                padding: 10px 12px;
                font-size: 13px;
                height: 70px;
                /* Adjusted fixed height for smaller screens */
            }

            #saveCustomInstructionsBtn {
                padding: 6px 14px;
                font-size: 13px;
            }
        }

        /* Profile Info (Account Tab) */
        .profile-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            height: 50px;
            padding: 0;
        }

        .profile-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 24px;
            font-weight: 400;
        }

        .inside-profile-info {
            display: flex;
            flex-direction: column;
            width: auto;
            flex: 1;
            align-items: left;
            justify-content: space-between;
            padding: 0;

        }

        .inside-profile-info p {
            font-size: 20px;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        body.dark-mode .profile-name {
            color: #e2e8f0;
        }

        .profile-email {
            font-size: 22px;
            color: #64748b;
        }

        body.dark-mode .profile-email {
            color: #a1a1aa;
        }

        /* Buttons */
        .tab-content button {
            padding: 10px 20px;
            background-color: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        .tab-content button:hover {
            background-color: #2563eb;
        }

        .inside-data-section {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 20px;
            justify-content: space-between;
        }

        .the-data-section {
            display: flex;
            flex-direction: column;
            margin-bottom: 30px;
        }

        .the-data-section h3,
        .the-data-section p {
            font-size: 15px;
        }

        .inside-data-section button {
            height: fit-content;
            width: fit-content;
            padding: 10px 32px;
            border-radius: 50px;
            background: #fff;
            color: #444;
            border: 1px solid #999;
            font-weight: 600;
        }

        #exportDataBtn:hover,
        #deleteConversationsBtn:hover {
            background-color: #f0f0f0;
        }

        #deleteAccountBtn {
            color: #ef4444;
        }

        #deleteAccountBtn:hover {
            background-color: #f0f0f0;
        }

        #closeSettings {
            position: relative;
            padding: 10px;
            background-color: #fff;
            color: #000;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 500;
            margin-bottom: 15px;
        }

        #closeSettings svg {
            color: #444;
        }

        #closeSettings:hover {
            background-color: #f0f0f0;
        }

        /* Descriptions and Text */
        .tab-content p {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 16px;
        }

        body.dark-mode .tab-content p {
            color: #a1a1aa;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .settings-modal-container {
                flex-direction: column;
                width: 90vw;
                height: 80vh;
            }

            .settings-sidebar {
                width: 100%;
                padding: 16px;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
                border-radius: 16px 16px 0 0;
            }

            body.dark-mode .settings-sidebar {
                border-bottom-color: #334155;
            }

            .settings-tabs {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
            }

            .settings-content {
                padding: 16px;
            }

            .theme-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .response-grid {
                grid-template-columns: 1fr;
            }

            #closeSettings {
                position: static;
                width: 100%;
                margin-top: 16px;
            }
        }

        @media (max-width: 480px) {
            .theme-grid {
                grid-template-columns: 1fr;
            }

            .tab-content label {
                font-size: 13px;
            }

            .tab-content h3 {
                font-size: 16px;
            }
        }

        /* Reduced Motion */
        body.reduced-motion * {
            transition: none !important;
            animation: none !important;
        }

        @media (max-width: 900px) {
            #chatContainer {
                padding: 24px;
            }

            .input-container {
                width: 100%;
                max-width: 600px;
            }
        }

        #newChatBtn {
            margin: 0;
            margin-left: auto;
            padding: 10px;
            background-color: #fff;
            border: 0 solid #d1d5db;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            right: 0;
        }

        #newChatBtn:hover {
            color: #000;
            background-color: #d8dce0;
        }

        #newChatBtn:active {
            transform: scale(0.95);
        }

        #toggleSidebar {
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            color: #555;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        #toggleSidebar svg {}

        #toggleSidebar:hover {
            color: #000;
            background-color: #e9e8e7;
        }

        /* Welcome Screen Styles */
        .welcome-container {
            height: 100%;
            margin-top: 0;
            padding: 24px 24px;
            padding-top: 110px;
            overflow-y: auto;
            background-color: #f9f8f6;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .welcome-container::-webkit-scrollbar {
            display: none;
        }

        .welcome-header {
            margin-bottom: 2rem;
            font-weight: 200;
            font-family: 'Roboto', san-serif;
            gap: 0;
        }

        .welcome-header h1,
        .welcome-container span {
            font-size: 30px;
            font-weight: 400;
            margin: 0;
        }

        .welcome-header h1 {
            color: #000;

        }

        .brand-name {
            background: linear-gradient(90deg, #4776E6, #8E54E9);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;

        }

        .welcome-subtitle {
            color: #7d8087;
            margin-top: 0;
            font-size: 30px;
            font-weight: 400;
            font-family: 'Roboto', san-serif;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            width: 100%;
            max-width: 900px;
            margin-bottom: 2rem;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            color: #6b46e5;
        }

        .feature-icon svg {
            width: 100%;
            height: 100%;
        }

        .feature-card h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
            color: var(--text-primary, #333);
        }

        .feature-card p {
            margin-bottom: 1.2rem;
            color: var(--text-secondary, #666);
            line-height: 1.5;
            flex-grow: 1;
        }

        .example-btn {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: var(--text-primary, #333);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .example-btn:hover {
            background: rgba(107, 70, 229, 0.1);
            border-color: #6b46e5;
            color: #6b46e5;
        }

        .model-selection {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .model-selection label {
            font-weight: 500;
            color: var(--text-primary, #333);
        }

        .model-selection select {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            background: transparent;
            color: var(--text-primary, #333);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .limitations {
            margin-top: 1rem;
            max-width: 600px;
            padding: 1rem;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.03);
        }

        .limitations h3 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: var(--text-primary, #333);
        }

        .limitations p {
            color: var(--text-secondary, #666);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Dark Mode Styles */
        body.dark-mode .welcome-container {
            background: var(--dark-bg, #1a1a1a);
        }

        body.dark-mode .welcome-subtitle,
        body.dark-mode .feature-card p,
        body.dark-mode .limitations p {
            color: #aaa;
        }

        body.dark-mode .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .feature-card h3,
        body.dark-mode .limitations h3,
        body.dark-mode .model-selection label {
            color: #ddd;
        }

        body.dark-mode .feature-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        body.dark-mode .example-btn {
            border-color: rgba(255, 255, 255, 0.2);
            color: #ddd;
        }

        body.dark-mode .example-btn:hover {
            background: rgba(107, 70, 229, 0.2);
            border-color: #8e54e9;
            color: #fff;
        }

        body.dark-mode .model-selection select {
            border-color: rgba(255, 255, 255, 0.2);
            color: #ddd;
            background: rgba(0, 0, 0, 0.2);
        }

        body.dark-mode .limitations {
            background: rgba(255, 255, 255, 0.05);
        }

        /* General Mobile Adjustments */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                /* Stack sidebar and main content vertically */
                overflow-y: auto;
                /* Allow scrolling on mobile */
            }

            #sidebar {
                width: 100%;
                /* Full width on mobile */
                height: auto;
                /* Adjust height dynamically */
                position: fixed;
                top: 0;
                left: -100%;
                /* Hidden by default */
                z-index: 20;
                transition: left 0.3s ease;
                background-color: #ffffff;
            }

            #sidebar.open {
                left: 0;
                /* Slide in when open */
            }

            #sidebar.collapsed {
                width: 100%;
                /* Still full width when collapsed */
                left: -100%;
                /* Hidden */
            }

            .main-content {
                width: 100%;
                /* Full width */
                margin-left: 0;
                /* No offset for sidebar */
            }

            nav {
                padding: 10px 16px;
                /* Reduce padding */
                height: 50px;
                /* Smaller nav bar */
            }

            nav h1 {
                font-size: 14px;
                /* Smaller title */
            }

            .nav-buttons {
                gap: 5px;
                /* Reduce spacing between buttons */
            }

            .nav-buttons button {
                padding: 6px;
                /* Smaller buttons */
            }

            #chatContainer {
                height: calc(100vh - 60px);
                top: 0;
                /* Adjust for smaller nav and footer */
                padding: 16px;
                /* Reduce padding */
                margin-top: 50px;
                /* Match nav height */
            }

            .message.user {
                max-width: 85%;
                /* Wider user messages */
            }

            .message.ai {
                font-size: 16px;
                /* Smaller text */
            }

            .input-container {
                width: 100%;
                /* Full width input */
                max-width: none;
                /* Remove max-width constraint */
                padding: 0 5px;
                /* Reduce padding */
            }

            #messageInput {
                font-size: 16px;
                /* Smaller input text */
                padding: 12px;
                /* Adjust padding */
            }

            #sendBtn,
            #micBtn {
                width: 32px;
                /* Smaller buttons */
                height: 32px;
            }

            footer {
                padding: 10px;
                /* Reduce padding */
                min-height: 70px;
                /* Smaller footer */
            }

            .welcome-container {
                padding: 16px;
                /* Reduce padding */
            }

            .features-grid {
                grid-template-columns: 1fr;
                /* Single column */
                gap: 1rem;
                /* Reduce gap */
            }

            .feature-card {
                padding: 1rem;
                /* Reduce padding */
            }

            #settingsModal>div {
                width: 90%;
                /* Nearly full width */
                max-width: 400px;
                /* Cap width */
            }

            #toggleSidebar {
                display: block;
                /* Ensure visibility */
            }
        }

        @media (max-width: 480px) {
            nav h1 {
                font-size: 12px;
                /* Even smaller title */
            }

            .nav-buttons button svg {
                width: 16px;
                /* Smaller icons */
                height: 16px;
            }

            .message {
                padding: 8px 12px;
                /* Reduce padding */
                font-size: 14px;
                /* Smaller text */
            }

            .message-actions button {
                padding: 4px;
                /* Smaller action buttons */
            }

            .message-actions svg {
                width: 14px;
                /* Smaller icons */
                height: 14px;
            }

            #messageInput {
                font-size: 14px;
                /* Smaller input text */
                padding: 10px;
                /* Further reduce padding */
            }

            .footer-info {
                font-size: 10px;
                /* Smaller footer text */
            }

            #scrollToBottomBtn {
                width: 32px;
                /* Smaller button */
                height: 32px;
                bottom: 100px;
                /* Adjust position */
                right: 10px;
            }

            .history-item {
                font-size: 12px;
                /* Smaller history text */
                padding: 6px 10px;
                /* Reduce padding */
            }

            .history-section-header {
                font-size: 12px;
                /* Smaller header */
                padding: 8px;
                /* Reduce padding */
            }

            #historySearch {
                font-size: 12px;
                /* Smaller search input */
                padding: 6px;
                /* Reduce padding */
            }

            .inside-login-modal {
                width: 90%;
                /* Nearly full width */
                padding: 16px;
                /* Reduce padding */
            }

            #emailInput,
            #passwordInput {
                font-size: 12px;
                /* Smaller input text */
                padding: 10px;
                /* Reduce padding */
            }

            #loginBtn,
            #signupBtn {
                padding: 10px;
                /* Reduce padding */
                font-size: 14px;
                /* Smaller text */
            }
        }

        /* Touch-friendly adjustments */
        button,
        .history-item,
        .feature-card,
        .example-btn {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            /* Reduce tap highlight */
            touch-action: manipulation;
            /* Improve touch responsiveness */
        }

        /* Ensure sidebar toggle button is visible and styled */
        #toggleSidebar {
            padding: 5px;
            margin-right: 10px;
        }

        #toggleSidebar svg {
            width: 18px;
            height: 18px;
        }

        /* Adjust context menu for mobile */
        .context-menu {
            width: 150px;
            /* Fixed width for smaller screens */
        }

        @media (max-width: 768px) {
            .context-menu {
                width: 120px;
                /* Smaller on mobile */
                font-size: 12px;
                /* Smaller text */
            }

            .context-menu button {
                padding: 6px 10px;
                /* Reduce padding */
            }

            .context-menu button svg {
                width: 14px;
                /* Smaller icons */
                height: 14px;
            }
        }

        /* Hide unnecessary elements on small screens */
        @media (max-width: 480px) {
            .tooltip {
                display: none;
                /* Hide tooltips on very small screens */
            }

            .nav-buttons .group:nth-child(n+4) {
                display: none;
                /* Hide less critical buttons (settings, dark mode, logout) */
            }
        }

        /* Context Menu */
        .context-menu {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .context-menu button {
            display: flex;
            width: 100%;
            border-radius: 5px;
            padding: 8px 12px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #0f172a;
            align-items: center;
            gap: 10px;
        }

        .context-menu button:hover {
            background-color: #f1f5f9;
        }

        .context-menu button svg {
            width: 17px;
            height: 17px;
        }

        .context-menu .delete-btn {
            color: #FF0000;
        }

        body.dark-mode .context-menu {
            background-color: #2d3748;
            border-color: #4b5563;
        }

        body.dark-mode .context-menu button {
            color: #e2e8f0;
        }

        body.dark-mode .context-menu button:hover {
            background-color: #4b5563;
        }

        /* Sidebar Profile */
        #sidebar-profile {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            background-color: #f9f9f9;
        }

        body.dark-mode #sidebar-profile {
            background-color: #2d3748;
            border-top-color: #4b5563;
        }

        .profile-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px;
            border-radius: 6px;
            color: #0f172a;
        }

        .profile-item:hover {
            background-color: #f1f5f9;
        }

        body.dark-mode .profile-item {
            color: #e2e8f0;
        }

        body.dark-mode .profile-item:hover {
            background-color: #4b5563;
        }

        .profile-item svg {
            width: 20px;
            height: 20px;
        }

        .profile-dropdown {
            position: absolute;
            bottom: 60px;
            left: 16px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
        }

        body.dark-mode .profile-dropdown {
            background: #2d3748;
            border-color: #4b5563;
        }

        .profile-dropdown button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #0f172a;
        }

        body.dark-mode .profile-dropdown button {
            color: #e2e8f0;
        }

        .profile-dropdown button:hover {
            background-color: #f1f5f9;
        }

        body.dark-mode .profile-dropdown button:hover {
            background-color: #4b5563;
        }

        /* Profile Settings Modal */
        #profileSettingsModal .modal-content textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
        }

        body.dark-mode #profileSettingsModal .modal-content textarea {
            border-color: #4b5563;
            background-color: #1f2937;
            color: #e2e8f0;
        }

        #profileSettingsModal .modal-content button {
            width: 100%;
            padding: 10px;
            background-color: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 16px;
        }

        #profileSettingsModal .modal-content button:hover {
            background-color: #2563eb;
        }

        .thread-reply {
            margin-left: 40px;
            padding: 10px;
            border-left: 2px solid #d1d5db;
            font-size: 15px;
        }

        body.dark-mode .thread-reply {
            border-left-color: #4b5563;
        }

        #historySearch {
            width: calc(100% - 14px);
            padding: 8px;
            margin: 8px 7px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            border-box: box-sizing;
        }

        #historySearch:focus {
            outline: none;
            border: 1px solid #bcbfc5;
        }

        body.dark-mode #historySearch {
            border-color: #4b5563;
            background: #2d3748;
            color: #e2e8f0;
        }

        #emailInput,
        #passwordInput {}

        .inside-login-modal input:focus {
            border: 2px solid #4776E6;
            outline: none;
        }

        /* Styling for the reply state in the input container */
        .input-container.replying {
            border-color: #4776E6;
            /* Blue border when replying */
            background-color: #f0f5ff;
            /* Light blue background */
            position: relative;
        }

        body.dark-mode .input-container.replying {
            border-color: #8E54E9;
            /* Purple border in dark mode */
            background-color: #2a3448;
            /* Darker background */
        }

        .reply-indicator {
            position: absolute;
            top: -20px;
            left: 16px;
            background: #4776E6;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }

        body.dark-mode .reply-indicator {
            background: #8E54E9;
        }

        .input-container.replying .reply-indicator {
            display: block;
        }

        .no-matches {
            padding: 16px;
            text-align: center;
            color: #64748b;
            font-size: 14px;
        }

        body.dark-mode .no-matches {
            color: #a0aec0;
        }
        
        .login-logo {
            background-image: url('https://s3.amazonaws.com/static.graphemica.com/glyphs/i500s/000/010/545/original/01B5-500x500.png?1275328666');
            width: 100px;
            height: 100px;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            margin-left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>

<body>
    <div id="loginModal" style="width: 100vw; height: 100vh; display: flex; position: fixed; inset: 0; background-color: #fff; justify-content: center; align-items: center;">
        <div class="inside-login-modal" style="margin-top: -130px; background-color: #fff; width: 400px; padding: 24px;">
            <div class="login-logo"></div>
            <h2 style="font-size: 30px; font-weight: 600; text-align: center; margin-bottom: 16px;">Welcome back</h2>
            <p style="text-align: center; font-size: 18px; color: #444; margin-bottom: 26px;">Login or Sign Up to access Zeta AI</p>
            <div style="margin-bottom: 16px;">
                <!--<label style="display: block; font-size: 14px; margin-bottom: 4px;">Email</label>-->
                <input id="emailInput" type="email" style="width: 100%; padding: 14px 14px; border: 2px solid #d1d5db; border-radius: 4px; font-size: 14px;" placeholder="Enter your email">
            </div>
            <div style="margin-bottom: 16px;">
                <!--<label style="display: block; font-size: 14px; margin-bottom: 4px;">Password</label>-->
                <input id="passwordInput" type="password" style="width: 100%; padding: 14px 14px; border: 2px solid #d1d5db; border-radius: 4px; font-size: 14px;" placeholder="Enter your password">
            </div>
            <button id="loginBtn" style="width: 100%; padding: 14px 14px; background-color: #3b82f6; color: #fff; border: none; border-radius: 0; cursor: pointer; margin-bottom: 10px;">Login</button>
            <button id="signupBtn" style="width: 100%; padding: 14px 14px; background-color: #fff; color: #000; border: 1px solid #999; border-radius: 0; cursor: pointer;">Sign Up</button>
            <p id="authError" style="color: #dc2626; font-size: 12px; margin-top: 8px; text-align: center; display: none;"></p>
        </div>
    </div>

    <div id="chatApp" style="display: none; width: 100vw; height: 100vh;">

        <aside id="sidebar">
            <div id="sidebar-header">
                <button id="clearHistoryBtn" title="Clear History">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                </button>
                <button id="sortToggleBtn" title="Toggle Sort">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                    </svg>
                </button>
                <button id="newChatBtn" title="New Chat">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                </button>
            </div>
            <input type="text" id="historySearch" placeholder="Search chats...">
            <div id="historyList" class="scrollbar-hide">
                <!-- History will be populated dynamically -->
            </div>
        </aside>

        <div class="main-content">
            <nav>
                <h1>
                    <button id="toggleSidebar" title="Toggle sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" />
                        </svg>
                    </button>
                    Zeta
                </h1>
                <div class="nav-buttons">
                    <div class="group">
                        <button id="shareBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path fill-rule="evenodd" d="M15.75 4.5a3 3 0 1 1 .825 2.066l-8.421 4.679a3.002 3.002 0 0 1 0 1.51l8.421 4.679a3 3 0 1 1-.729 1.31l-8.421-4.678a3 3 0 1 1 0-4.132l8.421-4.679a3 3 0 0 1-.096-.755Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span class="tooltip">Share Chat</span>
                    </div>
                    <div class="group">
                        <button id="settingsBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l-.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l-.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path>
                            </svg>
                        </button>
                        <span class="tooltip">Settings</span>
                    </div>
                    <div class="group" style="display: none;">
                        <button id="darkModeBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>
                        </button>
                        <span class="tooltip">Dark Mode</span>
                    </div>
                    <div class="group">
                        <button id="logoutBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                        </button>
                        <span class="tooltip">Logout</span>
                    </div>
                </div>
            </nav>

            <main id="chatContainer" class="scrollbar-hide">
                <!-- Welcome Container - Place this inside your chatContainer div -->
                <div id="welcomeContainer" class="welcome-container">
                    <div class="welcome-header">
                        <h1>Welcome to <span class="brand-name">Zeta</span></h1>
                        <p class="welcome-subtitle">How can I help you today?</p>
                    </div>
                    <div class="features-grid" style="display: none">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                                </svg>

                            </div>
                            <h3>Questions & Answers</h3>
                            <p>Ask anything from simple questions to complex problems.</p>
                            <button class="example-btn" data-prompt="What are the key differences between machine learning and deep learning?">What's the difference between ML and deep learning?</button>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                                </svg>

                            </div>
                            <h3>Creative Writing</h3>
                            <p>Get help with content creation, brainstorming, and more.</p>
                            <button class="example-btn" data-prompt="Write a short story about a robot who discovers it has feelings.">Write a short story about a robot with feelings</button>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0 0 21 18V6a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 6v12a2.25 2.25 0 0 0 2.25 2.25Z" />
                                </svg>

                            </div>
                            <h3>Code Assistance</h3>
                            <p>Get help with coding problems, debugging, and explanations.</p>
                            <button class="example-btn" data-prompt="Create a JavaScript function that sorts an array of objects by a specific property.">Create a function to sort objects by property</button>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z" />
                                </svg>

                            </div>
                            <h3>Learning & Explanation</h3>
                            <p>Break down complex topics into simple explanations.</p>
                            <button class="example-btn" data-prompt="Explain quantum computing to me as if I were a high school student.">Explain quantum computing simply</button>
                        </div>
                    </div>

                    <div class="limitations" style="display: none">
                        <h3>Limitations</h3>
                        <p>Zeta may produce inaccurate information about people, places, or facts.</p>
                    </div>
                </div>
            </main>

            <footer id="footer">
                <div class="input-container" id="input-container">

                    <textarea id="messageInput" placeholder="How can Zeta help?"></textarea>
                    <div class="inside-input-container">
                        <div class="input-actions">
                            <button id="fileUploadBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13" />
                                </svg>
                            </button>
                            <button id="searchBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="M21 21l-4.35-4.35"></path>
                                </svg>
                                Search
                            </button>
                        </div>
                        <button id="sendBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" />
                            </svg>
                        </button>
                    </div>


                </div>
                <div class="footer-info">Zeta may produce inaccurate information about people, places, or facts.</div>
            </footer>
            <button id="scrollToBottomBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 5.25 7.5 7.5 7.5-7.5m-15 6 7.5 7.5 7.5-7.5" />
                </svg>

            </button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="settings-modal-container">
            <div class="settings-sidebar">
                <button id="closeSettings">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>

                </button>
                <h2 style="display: none;">Settings</h2>
                <ul class="settings-tabs">
                    <li class="tab active" data-tab="account">Account</li>
                    <li class="tab" data-tab="appearance">Appearance</li>
                    <li class="tab" data-tab="behavior">Behavior</li>
                    <li class="tab" data-tab="customize">Customize</li>
                    <li class="tab" data-tab="data">Data</li>
                </ul>
            </div>
            <div class="settings-content">
                <!-- Account Tab -->
                <div id="account" class="tab-content active">
                    <h3>Account Information</h3>
                    <div class="profile-info">
                        <div class="profile-circle">{{userInitials}}</div>
                        <div class="inside-profile-info">
                            <p class="profile-name">{{userName}}</p>
                            <p class="profile-email">{{userEmail}}</p>
                        </div>
                    </div>
                    <button style="display: none;" id="editProfileBtn">Edit Profile</button>
                    <label for="nicknameInput" style="margin-top: 16px; display: none;">Nickname:
                        <input type="text" id="nicknameInput" placeholder="Enter your nickname" style="margin-top: 8px; width: 100%; max-width: 320px;">
                    </label>
                </div>

                <!-- Appearance Tab -->
                <div id="appearance" class="tab-content">
                    <h3>Theme</h3>
                    <div class="theme-grid">
                        <input type="radio" id="light" name="theme" value="light">
                        <label for="light"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                            </svg>
                            Light</label>

                        <input type="radio" id="dark" name="theme" value="dark">
                        <label for="dark"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                            </svg>
                            Dark</label>

                        <input type="radio" id="system" name="theme" value="system">
                        <label for="system"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
                            </svg>
                            System</label>
                    </div>
                    <h3>Display Options</h3>
                    <label><input type="checkbox" id="markdownMessages"> Display Your Message In Markdown</label>
                    <label><input type="checkbox" id="wrapCodeLines"> Wrap Long Lines For Code Blocks By Default</label>
                    <label><input type="checkbox" id="highContrast"> Enable High Contrast Mode</label>
                    <label><input type="checkbox" id="reducedMotion"> Reduce Animations</label>
                    <h3 style="display: none;">Font Settings</h3>
                    <label style="display: none;">Font Size: <input type="range" id="fontSizeInput" min="12" max="24" step="1"> <span id="fontSizeValue"></span>px</label>
                </div>

                <!-- Behavior Tab -->
                <div id="behavior" class="tab-content">
                    <h3>Interaction Options</h3>
                    <label><input type="checkbox" id="autoOpenSearch"> Automatically Open Search Results</label>
                    <label><input type="checkbox" id="followUpSuggestions"> Show Follow Up Suggestions</label>
                    <label><input type="checkbox" id="autoDetectURLs"> Auto Detect and Read URLs in Your Message</label>
                    <label><input type="checkbox" id="autoScroll"> Auto Scroll to Bottom on New Messages</label>
                    <label><input type="checkbox" id="confirmDelete"> Confirm Before Deleting Chats</label>
                    <h3 style="display: none;">Response Timing</h3>
                    <label style="display: none;">Typing Speed: <input type="range" id="typingSpeed" min="0" max="100" step="10"> <span id="typingSpeedValue"></span>ms</label>
                </div>

                <!-- Customize Tab -->
                <div id="customize" class="tab-content">
                    <h3>Customize Response</h3>
                    <p>Choose how Zeta responds to your queries.</p>
                    <div class="response-grid">
                        <input type="radio" id="concise" name="responseStyle" value="concise">
                        <label for="concise" class="response-option">
                            <span>Concise</span>
                            <p>Short and to the point</p>
                        </label>

                        <input type="radio" id="detailed" name="responseStyle" value="detailed">
                        <label for="detailed" class="response-option">
                            <span>Detailed</span>
                            <p>Comprehensive explanations</p>
                        </label>

                        <input type="radio" id="friendly" name="responseStyle" value="friendly">
                        <label for="friendly" class="response-option">
                            <span>Friendly</span>
                            <p>Warm and conversational</p>
                        </label>

                        <input type="radio" id="formal" name="responseStyle" value="formal">
                        <label for="formal" class="response-option">
                            <span>Formal</span>
                            <p>Professional and structured</p>
                        </label>
                    </div>
                    <div id="custom-instructions-container" style="display: none; margin-top: 16px;">
                        <label for="customInstructionsInput">Specific Instructions:</label>
                        <textarea id="customInstructionsInput" rows="4" placeholder="Enter specific instructions for this response style..."></textarea>
                        <button id="saveCustomInstructionsBtn" style="margin-top: 8px;">Save</button>
                    </div>
                </div>

                <!-- Data Tab -->
                <div id="data" class="tab-content">
                    <div class="inside-data-section">
                        <div class="the-data-section">
                            <h3>Export Account Data</h3>
                            <p>You can download all data associated with your account below. This data includes everything stored in all ZNet products.</p>
                        </div>
                        <button id="exportDataBtn">Export</button>
                    </div>
                    <div class="inside-data-section">
                        <div class="the-data-section">
                            <h3>Delete All Conversations</h3>
                            <p>Delete all of your conversation data.</p>
                        </div>
                        <button id="deleteConversationsBtn">Delete</button>
                    </div>
                    <div class="inside-data-section">
                        <div class="the-data-section">
                            <h3>Delete Account</h3>
                            <p>Permanently delete your account and associated data from the xAI platform. Deletions are immediate and cannot be undone.</p>
                        </div>
                        <button id="deleteAccountBtn">Delete</button>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>


    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDrltxD5Hg8iInjFVL01DfebSG_-zvSE3U",
            authDomain: "papar-io.firebaseapp.com",
            databaseURL: "https://papar-io-default-rtdb.firebaseio.com",
            projectId: "papar-io",
            storageBucket: "papar-io.firebasestorage.app",
            messagingSenderId: "523952897000",
            appId: "1:523952897000:web:5d252349d49c71194d825d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const state = {
            user: null,
            messages: [],
            chatHistory: [],
            currentChatId: null,
            isLoading: false,
            isSidebarOpen: false,
            isDarkMode: localStorage.getItem('darkMode') === 'true',
            isRecording: false,
            recognition: null,
            apiKeyPool: [{
                    key: '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',
                    usage: 0,
                    limit: 1000,
                    active: true
                }, // Example key 1
                {
                    key: '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',
                    usage: 0,
                    limit: 1000,
                    active: true
                },
                {
                    key: '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',
                    usage: 0,
                    limit: 1000,
                    active: true
                },
                {
                    key: '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',
                    usage: 0,
                    limit: 1000,
                    active: true
                },
                {
                    key: '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',
                    usage: 0,
                    limit: 1000,
                    active: true
                },
                {
                    key: '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',
                    usage: 0,
                    limit: 1000,
                    active: true
                }
            ],
            bucketResetInterval: 24 * 60 * 60 * 1000, // 24 hours
            retryCount: 0,
            maxRetries: 3,
            sortMode: 'date',
            settings: {
                defaultContext: 'You are Zeta, a helpful AI assistant developed by ZNet to assist users, while ensuring that responses utilise text formatting.',
                defaultModel: 'mixtral-8x7b-32768',
                temperature: 0.7,
                maxTokens: 1024,
                fontSize: 18,
                notificationsEnabled: true,
                theme: 'light', // New settings start here
                markdownMessages: false,
                wrapCodeLines: false,
                highContrast: false,
                reducedMotion: false,
                autoOpenSearch: false,
                followUpSuggestions: false,
                autoDetectURLs: false,
                autoScroll: true,
                confirmDelete: true,
                typingSpeed: 10,
                responseStyle: 'concise',
                customInstructions: {}, // New object to store instructions per style
                nickname: ''
            },
            currentResponseStyle: null,
        };

        // DOM Elements
        const elements = {
            loginModal: document.getElementById('loginModal'),
            chatApp: document.getElementById('chatApp'),
            sidebar: document.getElementById('sidebar'),
            chatContainer: document.getElementById('chatContainer'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            micBtn: document.getElementById('micBtn'),
            fileUploadBtn: document.querySelector('.input-actions button:nth-child(1)'),
            searchBtn: document.getElementById('searchBtn'),
            shareBtn: document.getElementById('shareBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            darkModeBtn: document.getElementById('darkModeBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            toggleSidebar: document.getElementById('toggleSidebar'),
            historyList: document.getElementById('historyList'),
            searchHistory: document.getElementById('searchHistory'),
            historySearch: document.getElementById('historySearch'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            sortToggleBtn: document.getElementById('sortToggleBtn'),
            newChatBtn: document.getElementById('newChatBtn'),
            welcomeContainer: document.getElementById('welcomeContainer'),
            scrollToBottomBtn: document.getElementById('scrollToBottomBtn'),
            settingsModal: document.getElementById('settingsModal'),
            tempInput: document.querySelector('#generalSettings input[type="range"]'),
            tempValue: document.getElementById('tempValue'),
            maxTokensInput: document.querySelector('#generalSettings input[type="number"]'),
            themeSelect: document.querySelector('#generalSettings select'),
            maxTokensInput: document.getElementById('maxTokensInput'),
            modelSelect: document.querySelector('#modelSettings select'),
            fontSizeInput: document.querySelector('#appearanceSettings input[type="range"]'),
            fontSizeValue: document.querySelector('#appearanceSettings span'),
            notificationsCheckbox: document.querySelector('#generalSettings input[type="checkbox"]'),
            closeSettings: document.getElementById('closeSettings'),
            settingsTabs: document.querySelectorAll('.settings-tabs .tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            exampleButtons: document.querySelectorAll('.example-btn'),
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            loginBtn: document.getElementById('loginBtn'),
            signupBtn: document.getElementById('signupBtn'),
            authError: document.getElementById('authError'),
            footer: document.getElementById('footer'),
            customInstructionsContainer: document.getElementById('custom-instructions-container'),
            customInstructionsInput: document.getElementById('customInstructionsInput'),
            saveCustomInstructionsBtn: document.getElementById('saveCustomInstructionsBtn'),
            nicknameInput: document.getElementById('nicknameInput')
        };

        const utils = {
            toggleElementDisplay: (element, display) => {
                element.style.display = display;
            },

            toggleLoading(isLoading) {
                state.isLoading = isLoading;
                elements.sendBtn.disabled = isLoading;
            },

            createContextMenu(chatId) {
                const menu = document.createElement('div');
                const chat = state.chatHistory.find(c => c.id === chatId);
                const pinText = chat.pinned ? 'Unpin' : 'Pin';
                menu.className = 'context-menu';
                menu.innerHTML = `
            <button data-action="pin" data-id="${chatId}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                </svg> ${pinText}
            </button>
            <button data-action="rename" data-id="${chatId}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                </svg> Rename
            </button>
            <button data-action="share" data-id="${chatId}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                </svg> Share
            </button>
            <button class="delete-btn" data-action="delete" data-id="${chatId}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg> Delete
            </button>
        `;
                menu.style.cssText = 'position: absolute; background: #fff; border: 1px solid #e5e7eb; border-radius: 15px; padding: 8px; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: block;';
                return menu;
            },

            showContextMenu(event, chatId) {
                event.preventDefault();
                event.stopPropagation(); // Prevent immediate closure from parent click events

                // Remove any existing context menu
                const existingMenu = document.querySelector('.context-menu');
                if (existingMenu) existingMenu.remove();

                // Create and position the new menu
                const menu = utils.createContextMenu(chatId);
                document.body.appendChild(menu);

                // Position the menu
                const rect = event.target.getBoundingClientRect();
                let top = rect.bottom + window.scrollY;
                let left = rect.left + window.scrollX;

                // Adjust if menu would go off-screen
                const menuHeight = menu.offsetHeight;
                const menuWidth = menu.offsetWidth;
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;

                if (top + menuHeight > viewportHeight + window.scrollY) {
                    top = rect.top + window.scrollY - menuHeight; // Flip above if no space below
                }
                if (left + menuWidth > viewportWidth + window.scrollX) {
                    left = viewportWidth + window.scrollX - menuWidth; // Adjust left if too wide
                }

                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;
                console.log('Context menu positioned at:', {
                    top,
                    left
                });

                // Handle menu actions
                menu.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = btn.dataset.action;
                        const id = btn.dataset.id;
                        if (action === 'pin') chatManager.pinChat(id);
                        else if (action === 'rename') chatManager.renameChat(id);
                        else if (action === 'share') chatManager.shareChat(id);
                        else if (action === 'delete') chatManager.deleteChat(id);
                        menu.remove();
                    });
                });

                // Close menu on outside click
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeMenu), 10); // Slight delay to avoid immediate closure
            },

            scrollToBottom() {
                elements.chatContainer.scrollTo({
                    top: elements.chatContainer.scrollHeight,
                    behavior: 'smooth'
                });
                setTimeout(() => {
                    if (elements.chatContainer.scrollHeight - elements.chatContainer.scrollTop - elements.chatContainer.clientHeight < 50) {
                        elements.scrollToBottomBtn.style.display = 'none';
                    }
                }, 500); // Delay to ensure scroll completes
            },

            updateMessageCount() {
                const count = state.messages.length;
                console.log(`Message count updated: ${count}`);
            },

            showNotification(message, type = 'info') {
                if (!state.settings.notificationsEnabled) return;
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.style.cssText = 'position: absolute; bottom: 165px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 15px; color: #000; z-index: 1000; font-size: 15px; border: 1px solid #eaeaea;';
                notification.style.backgroundColor = type === 'error' ? '#f9f8f6' : '#f9f8f6';
                notification.textContent = message;
                const oneInputContainer = document.getElementById('input-container');
                oneInputContainer.appendChild(notification);
                setTimeout(() => notification.remove(), 1500);
            },

            addMessage(content, role, scroll = true, id = Date.now(), parentId = null) {
                const div = document.createElement('div');
                div.className = `message ${role}${parentId ? ' thread-reply' : ''}`;
                div.dataset.id = id;
                div.dataset.parentId = parentId || '';
                const formattedContent = marked.parse(content || '', {
                    breaks: true,
                    gfm: true
                });
                div.innerHTML = `<div class="markdown-body">${formattedContent}</div>`;

                if (role === 'ai') {
                    div.innerHTML += `
                <div class="message-actions">
                    <button class="copy-btn" title="Copy">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                    </button>
                    <button class="regenerate-btn" title="Regenerate" data-id="${id}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                    </button>
                    <button class="edit-ai-btn" title="Edit" data-id="${id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="reply-btn" title="Reply" data-id="${id}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 0 1 1.037-.443 48.282 48.282 0 0 0 5.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z" />
                        </svg>
                    </button>
                </div>`;
                } else if (role === 'user') {
                    div.innerHTML += `
                <div class="message-actions">
                    <button class="edit-btn" title="Edit" data-id="${id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="reply-btn" title="Reply" data-id="${id}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 0 1 1.037-.443 48.282 48.282 0 0 0 5.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z" />
                        </svg>
                    </button>
                </div>`;
                }

                elements.chatContainer.appendChild(div);
                utils.formatCodeBlocks(div);
                if (scroll) utils.scrollToBottom();
                return div;
            },

            formatCodeBlocks(div) {
                const codeBlocks = div.querySelectorAll('pre code');
                codeBlocks.forEach(block => {
                    // Add copy button
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'code-copy-btn';
                    copyBtn.textContent = 'Copy';
                    copyBtn.addEventListener('click', () => {
                        navigator.clipboard.writeText(block.textContent || '');
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                    });
                    block.parentNode.insertBefore(copyBtn, block);

                    // Ensure language class is set (e.g., language-javascript)
                    if (!block.className) {
                        block.className = 'language-javascript'; // Default to JS, adjust as needed
                    } else if (!block.className.startsWith('language-')) {
                        block.className = `language-${block.className}`; // Prefix if needed
                    }

                    // Highlight with Prism.js
                    Prism.highlightElement(block);
                });
            },

            updateMessage(content, messageDiv) {
                const formattedContent = marked.parse(content, {
                    breaks: true,
                    gfm: true
                });
                messageDiv.querySelector('.markdown-body').innerHTML = formattedContent;
                utils.scrollToBottom();
            },

            addTypingIndicator() {
                const div = document.createElement('div');
                div.className = 'typing-indicator';
                div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
                elements.chatContainer.appendChild(div);
                utils.scrollToBottom();
                return div;
            }
        };

        // Chat Management
        const chatManager = {
            getAvailableApiKey() {
                const availableKey = state.apiKeyPool.find(k => k.active && k.usage < k.limit);
                if (!availableKey) {
                    utils.showNotification('All API keys exhausted. Please wait for reset.', 'error');
                    return null;
                }
                return availableKey;
            },

            resetApiKeyUsage() {
                setInterval(() => {
                    state.apiKeyPool.forEach(key => {
                        key.usage = 0;
                        key.active = true;
                    });
                    utils.showNotification('API key usage reset.', 'info');
                }, state.bucketResetInterval);
            },

            async renameChat(id) {
                const newName = prompt('Enter new chat name:', state.chatHistory.find(c => c.id === id).summary);
                if (!newName || !state.user) return;

                const chat = state.chatHistory.find(c => c.id === id);
                chat.summary = newName.slice(0, 20) + '...';
                chatManager.updateHistoryList();
                utils.showNotification('Chat renamed', 'info');

                try {
                    await db.collection('users').doc(state.user.uid).collection('chats').doc(id).update({
                        summary: chat.summary,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (err) {
                    console.error('Failed to rename chat:', err);
                    chatManager.loadChatHistory(); // Revert on failure
                    utils.showNotification('Failed to rename chat', 'error');
                }
            },

            shareChat(id) {
                const chat = state.chatHistory.find(c => c.id === id);
                const chatText = chat.messages.map(m => `${m.role === 'user' ? 'You' : 'Zeta'}: ${m.content}`).join('\n\n');
                navigator.clipboard.writeText(chatText).then(() => utils.showNotification('Chat copied to clipboard!', 'info'));
            },

            async sendMessage(message, parentId = null, retry = false) {
                if (!message || !state.user || state.isLoading) return;

                elements.welcomeContainer.style.display = 'none';
                elements.chatContainer.style.padding = '24px calc(50% - 375px)';
                elements.chatContainer.style.paddingTop = '84px';
                elements.chatContainer.style.height = 'calc(100vh - 160px)';
                elements.footer.style.position = 'absolute';
                const messageId = Date.now();

                if (!retry) {
                    utils.addMessage(message, 'user', true, messageId, parentId);
                    state.messages.push({
                        role: 'user',
                        content: message,
                        id: messageId,
                        parentId: parentId,
                        timestamp: new Date()
                    });
                }
                elements.messageInput.value = '';
                elements.messageInput.style.height = 'auto'; // Reset to auto to recalculate
                elements.messageInput.style.minHeight = '25px';
                utils.toggleLoading(true);

                const originalSendIcon = elements.sendBtn.innerHTML;
                elements.sendBtn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 23 24" stroke-width="2.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.25h13.5v13.5H5.25V5.25z" />
    </svg>
`;

                if (!state.currentChatId && state.messages.length === 1) {
                    await chatManager.createNewChat(message);
                }

                const typingIndicator = utils.addTypingIndicator();
                const apiKeyObj = chatManager.getAvailableApiKey();
                if (!apiKeyObj) {
                    elements.chatContainer.removeChild(typingIndicator);
                    utils.toggleLoading(false);
                    return;
                }

                try {
                    const contextMessages = parentId ?
                        state.messages.filter(m => m.id === parentId || m.parentId === parentId) :
                        state.messages;
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKeyObj.key}`
                        },
                        body: JSON.stringify({
                            messages: [{
                                    role: 'system',
                                    content: state.settings.defaultContext
                                },
                                ...contextMessages.map(m => ({
                                    role: m.role,
                                    content: m.content
                                }))
                            ],
                            model: state.settings.defaultModel,
                            temperature: state.settings.temperature,
                            max_tokens: state.settings.maxTokens,
                            stream: false
                        })
                    });

                    if (!response.ok) throw new Error(`API error: ${response.status}`);

                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;
                    apiKeyObj.usage += 1;
                    elements.chatContainer.removeChild(typingIndicator);

                    // Add AI message with typing effect and dynamic Prism highlighting
                    const aiMessageId = Date.now();
                    const aiMessageDiv = utils.addMessage('', 'ai', true, aiMessageId, parentId);
                    const contentDiv = aiMessageDiv.querySelector('.markdown-body');
                    let currentText = '';
                    const typingSpeed = 0.01; // Milliseconds per character

                    let inCodeBlock = false;
                    let codeBuffer = '';
                    let codeLanguage = '';
                    let codeStartIndex = -1;

                    for (let i = 0; i < aiResponse.length; i++) {
                        await new Promise(resolve => setTimeout(resolve, typingSpeed));
                        currentText += aiResponse[i];

                        // Detect code block start
                        if (!inCodeBlock && currentText.slice(-3) === '```') {
                            const match = currentText.match(/```(\w*)$/);
                            if (match) {
                                inCodeBlock = true;
                                codeLanguage = match[1] || 'javascript'; // Default to JS
                                codeBuffer = '';
                                codeStartIndex = i - (match[0].length - 1); // Track where code block starts
                            }
                        }
                        // Detect code block end
                        else if (inCodeBlock && currentText.slice(-3) === '```') {
                            inCodeBlock = false;
                            // Render everything up to this point with highlighting
                            contentDiv.innerHTML = marked.parse(currentText, {
                                breaks: true,
                                gfm: true
                            });
                            const codeBlocks = contentDiv.querySelectorAll('pre code');
                            codeBlocks.forEach(block => {
                                if (!block.className.startsWith('language-')) {
                                    block.className = `language-${codeLanguage}`;
                                }
                                Prism.highlightElement(block);
                            });
                            utils.formatCodeBlocks(aiMessageDiv); // Add copy buttons
                            codeBuffer = '';
                            codeStartIndex = -1;
                        }
                        // Inside code block
                        else if (inCodeBlock) {
                            codeBuffer += aiResponse[i];
                            // Render with partial code
                            const beforeCode = currentText.slice(0, codeStartIndex);
                            contentDiv.innerHTML = marked.parse(beforeCode, {
                                breaks: true,
                                gfm: true
                            });
                            const preElement = document.createElement('pre');
                            const codeElement = document.createElement('code');
                            codeElement.className = `language-${codeLanguage}`;
                            codeElement.textContent = codeBuffer;
                            preElement.appendChild(codeElement);
                            contentDiv.appendChild(preElement);
                            Prism.highlightElement(codeElement);
                        }
                        // Outside code block
                        else {
                            contentDiv.innerHTML = marked.parse(currentText, {
                                breaks: true,
                                gfm: true
                            });
                        }

                        const isNearBottom = elements.chatContainer.scrollHeight - elements.chatContainer.scrollTop - elements.chatContainer.clientHeight < 100;
                        if (isNearBottom) {
                            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
                        }
                    }

                    // Final render to catch any remaining content
                    contentDiv.innerHTML = marked.parse(aiResponse, {
                        breaks: true,
                        gfm: true
                    });
                    const codeBlocks = contentDiv.querySelectorAll('pre code');
                    codeBlocks.forEach(block => {
                        if (!block.className.startsWith('language-')) {
                            block.className = `language-${codeLanguage || 'javascript'}`; // Use last detected language or default
                        }
                        Prism.highlightElement(block);
                    });
                    utils.formatCodeBlocks(aiMessageDiv); // Add copy buttons

                    // Finalize message in state
                    state.messages.push({
                        role: 'assistant',
                        content: aiResponse,
                        id: aiMessageId,
                        parentId: parentId,
                        timestamp: new Date()
                    });
                    await chatManager.saveChat();
                    state.retryCount = 0;
                } catch (error) {
                    console.error('Send message error:', error);
                    elements.chatContainer.removeChild(typingIndicator);
                    apiKeyObj.usage += 1;
                    if (state.retryCount < state.maxRetries) {
                        state.retryCount++;
                        utils.showNotification(`Retrying (${state.retryCount}/${state.maxRetries})`, 'info');
                        setTimeout(() => chatManager.sendMessage(message, parentId, true), 2000);
                    } else {
                        apiKeyObj.active = false;
                        utils.addMessage('API limit reached. Please try again later.', 'ai');
                        state.messages.push({
                            role: 'assistant',
                            content: 'API limit reached. Please try again later.',
                            id: Date.now(),
                            parentId: parentId,
                            timestamp: new Date()
                        });
                        await chatManager.saveChat();
                        utils.showNotification('Switched to fallback due to API limit.', 'error');
                    }
                } finally {
                    elements.sendBtn.innerHTML = originalSendIcon;
                    utils.toggleLoading(false);
                }
            },

            async createNewChat(firstMessage) {
                if (!state.user) return;
                try {
                    const docRef = await db.collection('users').doc(state.user.uid).collection('chats').add({
                        summary: firstMessage.slice(0, 20) + '...',
                        messages: [],
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        pinned: false
                    });
                    state.currentChatId = docRef.id;
                    await chatManager.loadChatHistory();
                    utils.showNotification('New chat created!', 'info');
                } catch (error) {
                    console.error('Error creating chat:', error);
                    utils.showNotification('Failed to create chat.', 'error');
                }
            },

            async saveChat() {
                if (!state.user || !state.currentChatId) return;
                const chatSummary = state.messages[0]?.content.slice(0, 20) + '...';
                try {
                    await db.collection('users').doc(state.user.uid).collection('chats').doc(state.currentChatId).set({
                        summary: chatSummary,
                        messages: state.messages,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        pinned: state.chatHistory.find(c => c.id === state.currentChatId)?.pinned || false
                    }, {
                        merge: true
                    });
                    await chatManager.loadChatHistory();
                } catch (error) {
                    console.error('Error saving chat:', error);
                    utils.showNotification('Failed to save chat.', 'error');
                }
            },

            async pinChat(id) {
                if (!state.user) return;
                const chat = state.chatHistory.find(c => c.id === id);
                const newPinnedState = !chat.pinned;

                // Update local state immediately
                chat.pinned = newPinnedState;
                this.updateHistoryList();
                utils.showNotification(chat.pinned ? 'Chat pinned' : 'Chat unpinned', 'info');

                // Sync with Firestore in the background
                db.collection('users').doc(state.user.uid).collection('chats').doc(id).update({
                    pinned: newPinnedState,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(err => {
                    console.error('Failed to pin chat in Firestore:', err);
                    // Revert local state on failure
                    chat.pinned = !newPinnedState;
                    this.updateHistoryList();
                    utils.showNotification('Failed to update pin status', 'error');
                });
            },

            shareChat(id) {
                const chat = state.chatHistory.find(c => c.id === id);
                const chatText = chat.messages.map(m => `${m.role === 'user' ? 'You' : 'Zeta'}: ${m.content}`).join('\n\n');
                navigator.clipboard.writeText(chatText).then(() => utils.showNotification('Chat copied to clipboard!', 'info'));
            },

            async deleteChat(id) {
                if (!state.user) return;

                // Update local state immediately
                const chatIndex = state.chatHistory.findIndex(c => c.id === id);
                if (chatIndex !== -1) {
                    state.chatHistory.splice(chatIndex, 1);
                    if (state.currentChatId === id) chatManager.resetChat();
                    this.updateHistoryList();
                    utils.showNotification('Chat deleted', 'info');
                }

                // Sync with Firestore in the background
                db.collection('users').doc(state.user.uid).collection('chats').doc(id).delete()
                    .catch(err => {
                        console.error('Failed to delete chat in Firestore:', err);
                        // Revert local state on failure (re-fetch history as a fallback)
                        chatManager.loadChatHistory();
                        utils.showNotification('Failed to delete chat', 'error');
                    });
            },

            async renameChat(id) {
                const newName = prompt('Enter new chat name:', state.chatHistory.find(c => c.id === id).summary);
                if (!newName || !state.user) return;

                // Update local state immediately
                const chat = state.chatHistory.find(c => c.id === id);
                chat.summary = newName.slice(0, 20) + '...';
                this.updateHistoryList();
                utils.showNotification('Chat renamed', 'info');

                // Sync with Firestore in the background
                db.collection('users').doc(state.user.uid).collection('chats').doc(id).update({
                    summary: newName.slice(0, 20) + '...',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(err => {
                    console.error('Failed to rename chat in Firestore:', err);
                    // Revert local state on failure
                    chat.summary = state.chatHistory.find(c => c.id === id)?.summary || '';
                    this.updateHistoryList();
                    utils.showNotification('Failed to rename chat', 'error');
                });
            },

            async loadChatHistory() {
                if (!state.user) return;
                try {
                    const snapshot = await db.collection('users').doc(state.user.uid).collection('chats')
                        .orderBy('lastUpdated', 'desc')
                        .get();
                    state.chatHistory = snapshot.docs.map(doc => ({
                        id: doc.id,
                        summary: doc.data().summary || 'Untitled Chat',
                        messages: doc.data().messages || [],
                        pinned: doc.data().pinned || false,
                        timestamp: doc.data().timestamp
                    }));
                    chatManager.updateHistoryList();
                } catch (error) {
                    console.error('Error loading chat history:', error);
                    utils.showNotification('Failed to load chat history.', 'error');
                }
            },

            updateHistoryList(searchTerm = '') {
                elements.historyList.innerHTML = ''; // Clear current history list

                // Filter chats based on search term
                const filteredChats = state.chatHistory.filter(chat =>
                    chat.summary.toLowerCase().includes(searchTerm.toLowerCase())
                );

                // If no chats exist at all
                if (state.chatHistory.length === 0) {
                    const placeholderDiv = document.createElement('div');
                    placeholderDiv.className = 'history-placeholder';
                    placeholderDiv.style.padding = '16px';
                    placeholderDiv.style.textAlign = 'center';
                    placeholderDiv.style.color = '#64748b';
                    placeholderDiv.style.fontSize = '14px';
                    placeholderDiv.textContent = 'Send a message to create a chat';
                    elements.historyList.appendChild(placeholderDiv);
                    return;
                }

                // If search term exists but no matches found
                if (searchTerm && filteredChats.length === 0) {
                    const noMatchesDiv = document.createElement('div');
                    noMatchesDiv.className = 'no-matches';
                    noMatchesDiv.style.padding = '16px';
                    noMatchesDiv.style.textAlign = 'center';
                    noMatchesDiv.style.color = '#64748b';
                    noMatchesDiv.style.fontSize = '14px';
                    noMatchesDiv.textContent = 'No matches found';
                    elements.historyList.appendChild(noMatchesDiv);
                    return;
                }

                // Group and sort chats
                const pinnedChats = filteredChats.filter(chat => chat.pinned);
                const unpinnedChats = filteredChats.filter(chat => !chat.pinned);

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const last7Days = new Date(today);
                last7Days.setDate(today.getDate() - 7);

                let groupedChats = {};
                if (state.sortMode === 'date') {
                    groupedChats = {
                        'Today': [],
                        'Last 7 Days': [],
                        'Older': []
                    };
                    unpinnedChats.forEach(chat => {
                        const chatDate = chat.timestamp?.toDate ? chat.timestamp.toDate() : new Date();
                        if (chatDate >= today) groupedChats['Today'].push(chat);
                        else if (chatDate >= last7Days) groupedChats['Last 7 Days'].push(chat);
                        else groupedChats['Older'].push(chat);
                    });
                } else {
                    groupedChats = {
                        'All Chats': unpinnedChats.sort((a, b) => a.summary.localeCompare(b.summary))
                    };
                }

                // Render pinned chats
                if (pinnedChats.length > 0) {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'history-section-header pinned';
                    headerDiv.innerHTML = '<span>Pinned</span>';
                    elements.historyList.appendChild(headerDiv);
                    pinnedChats.forEach(chat => chatManager.renderChatItem(chat));
                }

                // Render grouped chats
                Object.keys(groupedChats).forEach(section => {
                    if (groupedChats[section].length > 0) {
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'history-section-header';
                        headerDiv.innerHTML = `<span>${section}</span>`;
                        elements.historyList.appendChild(headerDiv);
                        groupedChats[section].forEach(chat => chatManager.renderChatItem(chat));
                    }
                });
            },




            renderChatItem(chat) {
                console.log('Rendering chat item:', chat);
                const div = document.createElement('div');
                div.className = `history-item ${state.currentChatId === chat.id ? 'active' : ''}`;
                div.innerHTML = `
        <span>${chat.summary || 'Untitled Chat'}</span>
        <button class="ellipsis-btn" data-id="${chat.id}">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"> 
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /> 
            </svg>
        </button>
    `;
                div.addEventListener('click', (e) => {
                    if (!e.target.closest('.ellipsis-btn')) {
                        console.log('Clicked chat item, loading chat:', chat.id);
                        this.loadChat(chat.id);
                    }
                });
                div.querySelector('.ellipsis-btn').addEventListener('click', (e) => {
                    utils.showContextMenu(e, chat.id);
                });
                elements.historyList.appendChild(div);
            },

            async pinChat(id) {
                if (!state.user) return;
                const chat = state.chatHistory.find(c => c.id === id);
                chat.pinned = !chat.pinned;
                chatManager.updateHistoryList();
                utils.showNotification(chat.pinned ? 'Chat pinned' : 'Chat unpinned', 'info');

                try {
                    await db.collection('users').doc(state.user.uid).collection('chats').doc(id).update({
                        pinned: chat.pinned,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (err) {
                    console.error('Failed to pin chat:', err);
                    chat.pinned = !chat.pinned;
                    chatManager.updateHistoryList();
                    utils.showNotification('Failed to pin chat', 'error');
                }
            },

            async clearHistory() {
                if (!state.user || !confirm('Delete all chats?')) return;
                try {
                    const batch = db.batch();
                    const chatsRef = db.collection('users').doc(state.user.uid).collection('chats');
                    const snapshot = await chatsRef.get();
                    snapshot.docs.forEach(doc => batch.delete(chatsRef.doc(doc.id)));
                    await batch.commit();
                    chatManager.resetChat();
                    await chatManager.loadChatHistory();
                    utils.showNotification('Chat history cleared.', 'info');
                } catch (error) {
                    console.error('Error clearing history:', error);
                    utils.showNotification('Failed to clear history.', 'error');
                }
            },

            async deleteChat(id) {
                if (!state.user) return;
                const chatIndex = state.chatHistory.findIndex(c => c.id === id);
                if (chatIndex === -1) return;

                state.chatHistory.splice(chatIndex, 1);
                if (state.currentChatId === id) chatManager.resetChat();
                chatManager.updateHistoryList();
                utils.showNotification('Chat deleted', 'info');

                try {
                    await db.collection('users').doc(state.user.uid).collection('chats').doc(id).delete();
                } catch (err) {
                    console.error('Failed to delete chat:', err);
                    chatManager.loadChatHistory();
                    utils.showNotification('Failed to delete chat', 'error');
                }
            },

            loadChat(id) {
                state.currentChatId = id;
                const chat = state.chatHistory.find(c => c.id === id);
                if (!chat) {
                    utils.showNotification('Chat not found.', 'error');
                    return;
                }

                state.messages = chat.messages.map(msg => ({
                    ...msg,
                    id: msg.id || Date.now(),
                    timestamp: msg.timestamp || new Date()
                })).sort((a, b) => a.id - b.id);

                elements.chatContainer.innerHTML = '';
                elements.welcomeContainer.style.display = 'none';
                adjustChatContainerPadding();

                elements.chatContainer.style.height = 'calc(100vh - 160px)';
                elements.footer.style.position = 'absolute';

                state.messages.forEach(msg => utils.addMessage(msg.content, msg.role, false, msg.id, msg.parentId));
                utils.updateMessageCount();
                utils.scrollToBottom();
                chatManager.updateHistoryList();
            },

            resetChat() {
                state.messages = [];
                state.currentChatId = null;
                elements.chatContainer.innerHTML = ''; // Clear current messages
                elements.welcomeContainer.style.display = 'flex'; // Show welcome container
                elements.chatContainer.appendChild(elements.welcomeContainer); // Ensure itâ€™s inside chatContainer
                elements.chatContainer.style.height = 'calc(50vh - 50px)'; // Restore initial height
                elements.chatContainer.style.padding = '0 calc(50% - 375px)'; // Restore initial padding
                elements.chatContainer.style.paddingTop = '0'; // Reset top padding
                elements.footer.style.position = 'relative'; // Restore footer position
                utils.updateMessageCount();
                chatManager.updateHistoryList();
            },

            async regenerateMessage(messageId) {
                const messageIndex = state.messages.findIndex(m => m.id === messageId);
                if (messageIndex <= 0 || state.messages[messageIndex].role !== 'assistant') {
                    utils.showNotification('Cannot regenerate this message.', 'error');
                    return;
                }

                const userMessage = state.messages[messageIndex - 1];
                if (userMessage.role !== 'user') {
                    utils.showNotification('No user message to regenerate from.', 'error');
                    return;
                }

                // Remove the AI response and all subsequent messages in the thread
                state.messages.splice(messageIndex);
                elements.chatContainer.innerHTML = '';
                state.messages.forEach(msg => utils.addMessage(msg.content, msg.role, false, msg.id, msg.parentId));
                await chatManager.sendMessage(userMessage.content, userMessage.parentId);
            },

            editMessage(messageId) {
                const message = state.messages.find(m => m.id === messageId);
                if (!message || message.role !== 'user') return;

                elements.messageInput.value = message.content;
                state.messages = state.messages.filter(m => m.id !== messageId);
                elements.chatContainer.innerHTML = '';
                state.messages.forEach(msg => utils.addMessage(msg.content, msg.role, false, msg.id, msg.parentId));
                utils.updateMessageCount();
                elements.messageInput.focus();
            }
        };

        // Voice Input
        const voiceManager = {
            start() {
                if (!('webkitSpeechRecognition' in window)) {
                    utils.showNotification('Voice input not supported.', 'error');
                    return;
                }
                state.recognition = new webkitSpeechRecognition();
                state.recognition.continuous = true;
                state.recognition.interimResults = true;

                state.recognition.onstart = () => {
                    state.isRecording = true;
                    elements.micBtn.classList.add('recording');
                    utils.showNotification('Recording started.', 'info');
                };

                state.recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    elements.messageInput.value = transcript;
                };

                state.recognition.onerror = (event) => {
                    console.error('Voice error:', event.error);
                    voiceManager.stop();
                    utils.showNotification('Voice recognition failed.', 'error');
                };

                state.recognition.onend = () => {
                    if (state.isRecording) state.recognition.start(); // Restart if stopped unexpectedly
                };

                state.recognition.start();
                setTimeout(voiceManager.stop, 10000); // Auto-stop after 10s
            },

            stop() {
                if (state.recognition) {
                    state.recognition.stop();
                    state.recognition = null;
                }
                state.isRecording = false;
                elements.micBtn.classList.remove('recording');
                utils.showNotification('Recording stopped.', 'info');
            }
        };

        // Event Listeners and Initialization
        auth.onAuthStateChanged(async (user) => {
            state.user = user;
            if (user) {
                utils.toggleElementDisplay(elements.loginModal, 'none');
                utils.toggleElementDisplay(elements.chatApp, 'flex');
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists && userDoc.data().settings) {
                    state.settings = {
                        ...state.settings,
                        ...userDoc.data().settings
                    };
                }
                chatManager.loadChatHistory();
            } else {
                utils.toggleElementDisplay(elements.loginModal, 'flex');
                utils.toggleElementDisplay(elements.chatApp, 'none');
                elements.authError.style.display = 'none';
                const savedSettings = localStorage.getItem('settings');
                if (savedSettings) state.settings = {
                    ...state.settings,
                    ...JSON.parse(savedSettings)
                };
            }
            applySettings();
        });

        document.getElementById('exportDataBtn').addEventListener('click', async () => {
            if (!state.user) return;
            const data = {
                chats: state.chatHistory,
                settings: state.settings
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zeta-data-${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            utils.showNotification('Data exported.', 'info');
        });

        document.getElementById('deleteConversationsBtn').addEventListener('click', async () => {
            if (state.settings.confirmDelete && !confirm('Are you sure you want to delete all conversations?')) return;
            await chatManager.clearHistory();
        });

        document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to permanently delete your account? This cannot be undone.')) return;
            if (state.user) {
                await db.collection('users').doc(state.user.uid).delete();
                await state.user.delete();
                auth.signOut();
                utils.showNotification('Account deleted.', 'info');
            }
        });

        document.getElementById('typingSpeed').addEventListener('input', () => {
            document.getElementById('typingSpeedValue').textContent = document.getElementById('typingSpeed').value;
        });

        elements.loginBtn.addEventListener('click', async () => {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            if (!email || !password) {
                elements.authError.textContent = 'Email and password required.';
                elements.authError.style.display = 'block';
                return;
            }
            try {
                await auth.signInWithEmailAndPassword(email, password);
                utils.showNotification('Logged in!', 'info');
            } catch (error) {
                elements.authError.textContent = error.message;
                elements.authError.style.display = 'block';
            }
        });

        elements.signupBtn.addEventListener('click', async () => {
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            if (!email || !password) {
                elements.authError.textContent = 'Email and password required.';
                elements.authError.style.display = 'block';
                return;
            }
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                utils.showNotification('Signed up!', 'info');
            } catch (error) {
                elements.authError.textContent = error.message;
                elements.authError.style.display = 'block';
            }
        });

        elements.logoutBtn.addEventListener('click', () => {
            auth.signOut();
            utils.showNotification('Logged out.', 'info');
        });
        elements.sendBtn.addEventListener('click', () => chatManager.sendMessage(elements.messageInput.value.trim()));

        elements.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatManager.sendMessage(elements.messageInput.value.trim());
            }
        });

        let resizeTimeout;
        elements.messageInput.addEventListener('input', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                elements.messageInput.style.minHeight = '25px';
                elements.messageInput.style.maxHeight = '200px';
                elements.messageInput.style.height = 'auto'

                elements.messageInput.style.height = `${Math.min(elements.messageInput.scrollHeight, 200)}px`;
            }, 100);
        });

        elements.toggleSidebar.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                // Mobile: Toggle 'open' class
                elements.sidebar.classList.toggle('open');
                state.isSidebarOpen = elements.sidebar.classList.contains('open');
            } else {
                // Desktop: Toggle 'collapsed' class
                elements.sidebar.classList.toggle('collapsed');
                state.isSidebarOpen = !elements.sidebar.classList.contains('collapsed');
            }
        });

        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && state.isSidebarOpen && !elements.sidebar.contains(e.target) && !elements.toggleSidebar.contains(e.target)) {
                state.isSidebarOpen = false;
                elements.sidebar.classList.remove('open');
            }
        });

        function adjustChatContainerPadding() {
            if (window.innerWidth <= 768) {
                elements.chatContainer.style.padding = state.currentChatId ? '16px' : '16px';
            } else {
                elements.chatContainer.style.padding = state.currentChatId ? '24px calc(50% - 375px)' : '0 calc(50% - 375px)';
                elements.chatContainer.style.paddingTop = state.currentChatId ? '84px' : '0';
            }
        }

        window.addEventListener('resize', adjustChatContainerPadding);
        window.addEventListener('DOMContentLoaded', adjustChatContainerPadding);

        elements.newChatBtn.addEventListener('click', () => chatManager.resetChat());

        elements.fileUploadBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.pdf,.jpg,.png';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        let message;
                        if (file.type === 'text/plain') {
                            message = `Analyze this text file:\n${event.target.result}`;
                        } else if (file.type.startsWith('image/')) {
                            message = `Analyze this image: [Image: ${file.name}] - Description: Mock analysis result.`;
                        } else if (file.type === 'application/pdf') {
                            message = `Analyze this PDF: [PDF: ${file.name}] - Content not extracted (mock result).`;
                        } else {
                            message = `Unsupported file: ${file.name}`;
                        }
                        elements.messageInput.value = message;
                        chatManager.sendMessage(message);
                    };
                    reader.onerror = () => utils.showNotification('Failed to read file.', 'error');
                    reader.readAsText(file);
                }
            };
            input.click();
        });

        elements.searchBtn.addEventListener('click', () => {
            elements.searchBtn.classList.toggle('active');
            if (elements.searchBtn.classList.contains('active')) {
                utils.showNotification('Search mode activated. Type your query and send.', 'info');
                elements.messageInput.focus();
            } else {
                utils.showNotification('Search mode deactivated.', 'info');
            }
        });

        elements.shareBtn.addEventListener('click', () => {
            const chatText = state.messages.map(m => `${m.role === 'user' ? 'You' : 'Zeta'}: ${m.content}`).join('\n\n');
            navigator.clipboard.writeText(chatText).then(() => utils.showNotification('Chat copied!', 'info'));
        });

        elements.settingsTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                elements.settingsTabs.forEach(t => t.classList.remove('active'));
                elements.tabContents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        elements.settingsBtn.addEventListener('click', () => {
            utils.toggleElementDisplay(elements.settingsModal, 'flex');
            // Populate settings (keep this part as is)
            const userEmail = state.user ? state.user.email : 'guest@example.com';
            const userName = userEmail.split('@')[0];
            const initials = userName.charAt(0).toUpperCase();
            document.querySelector('#account .profile-circle').textContent = initials;
            document.querySelector('#account .profile-name').textContent = userName;
            document.querySelector('#account .profile-email').textContent = userEmail;
            elements.nicknameInput.value = state.settings.nickname || '';

            document.querySelectorAll('.theme-grid input[name="theme"]').forEach(radio => {
                radio.checked = radio.value === state.settings.theme;
            });
            document.getElementById('markdownMessages').checked = state.settings.markdownMessages;
            document.getElementById('wrapCodeLines').checked = state.settings.wrapCodeLines;
            document.getElementById('highContrast').checked = state.settings.highContrast;
            document.getElementById('reducedMotion').checked = state.settings.reducedMotion;
            elements.fontSizeInput.value = state.settings.fontSize;
            elements.fontSizeValue.textContent = state.settings.fontSize;

            document.getElementById('autoOpenSearch').checked = state.settings.autoOpenSearch;
            document.getElementById('followUpSuggestions').checked = state.settings.followUpSuggestions;
            document.getElementById('autoDetectURLs').checked = state.settings.autoDetectURLs;
            document.getElementById('autoScroll').checked = state.settings.autoScroll;
            document.getElementById('confirmDelete').checked = state.settings.confirmDelete;
            document.getElementById('typingSpeed').value = state.settings.typingSpeed;
            document.getElementById('typingSpeedValue').textContent = state.settings.typingSpeed;

            document.querySelector(`input[name="responseStyle"][value="${state.settings.responseStyle}"]`).checked = true;
            document.getElementById('customInstruction').value = state.settings.customInstruction;
            elements.tempInput.value = state.settings.temperature;
            elements.tempValue.textContent = state.settings.temperature;
            elements.maxTokensInput.value = state.settings.maxTokens;
        });

        elements.nicknameInput.addEventListener('input', debounce((e) => {
            updateSetting('nickname', e.target.value.trim());
            utils.showNotification('Nickname updated!', 'info');
        }, 300));

        elements.settingsModal.addEventListener('click', (e) => {
            if (e.target === elements.settingsModal) {
                utils.toggleElementDisplay(elements.settingsModal, 'none');
            }
        });

        // Close modal with the close button (single listener)
        elements.closeSettings.addEventListener('click', () => {
            utils.toggleElementDisplay(elements.settingsModal, 'none');
        });

        function applySettings() {
            if (state.settings.theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (state.settings.theme === 'light') {
                document.body.classList.remove('dark-mode');
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.body.classList.toggle('dark-mode', prefersDark);
            }
            elements.chatContainer.style.fontSize = `${state.settings.fontSize}px`;
            elements.messageInput.style.fontSize = `${state.settings.fontSize}px`;
            document.body.classList.toggle('high-contrast', state.settings.highContrast);
            document.body.classList.toggle('reduced-motion', state.settings.reducedMotion);
            if (state.settings.autoScroll) {
                elements.chatContainer.addEventListener('DOMNodeInserted', utils.scrollToBottom);
            } else {
                elements.chatContainer.removeEventListener('DOMNodeInserted', utils.scrollToBottom);
            }
        }

        async function saveSettings() {
            try {
                if (state.user && typeof db !== 'undefined') {
                    await db.collection('users').doc(state.user.uid).collection('settings').doc('current').set({
                        settings: state.settings,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('Settings saved to Firestore:', state.settings);
                } else {
                    localStorage.setItem('settings', JSON.stringify(state.settings));
                    console.log('Settings saved to localStorage:', state.settings);
                }
                applySettings();
            } catch (error) {
                console.error('Error saving settings:', error);
                utils.showNotification('Failed to save settings: ' + error.message, 'error');
            }
        }

        function updateSetting(key, value) {
            state.settings[key] = value;
            saveSettings();
        }

        function debounce(func, wait) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        };

        const addChangeListener = (id, key, type, transform = (v) => v) => {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with ID '${id}' not found`);
                return;
            }
            element.addEventListener(type, (e) => {
                updateSetting(key, transform(e.target[type === 'change' && e.target.type === 'checkbox' ? 'checked' : 'value']));
            });
        };

        addChangeListener('markdownMessages', 'markdownMessages', 'change');
        addChangeListener('wrapCodeLines', 'wrapCodeLines', 'change');
        addChangeListener('highContrast', 'highContrast', 'change');
        addChangeListener('reducedMotion', 'reducedMotion', 'change');
        addChangeListener('fontSizeInput', 'fontSize', 'input', parseInt);
        addChangeListener('autoOpenSearch', 'autoOpenSearch', 'change');
        addChangeListener('followUpSuggestions', 'followUpSuggestions', 'change');
        addChangeListener('autoDetectURLs', 'autoDetectURLs', 'change');
        addChangeListener('autoScroll', 'autoScroll', 'change');
        addChangeListener('confirmDelete', 'confirmDelete', 'change');
        addChangeListener('typingSpeed', 'typingSpeed', 'input', parseInt);

        // Handle response style selection
        document.querySelectorAll('.response-grid input[name="responseStyle"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    updateSetting('responseStyle', e.target.value);
                    // Show custom instructions container
                    elements.customInstructionsContainer.style.display = 'block';
                    // Load existing custom instructions if any
                    const existingInstructions = state.settings.customInstructions?.[e.target.value] || '';
                    elements.customInstructionsInput.value = existingInstructions;
                    state.currentResponseStyle = e.target.value; // Track selected style
                }
            });
        });

        // Save custom instructions
        elements.saveCustomInstructionsBtn.addEventListener('click', () => {
            const instructions = elements.customInstructionsInput.value.trim();
            if (!state.currentResponseStyle) return;
            state.settings.customInstructions = state.settings.customInstructions || {};
            state.settings.customInstructions[state.currentResponseStyle] = instructions;
            saveSettings();
            utils.showNotification('Custom instructions saved!', 'info');
            elements.customInstructionsContainer.style.display = 'none'; // Hide after saving
        });

        addChangeListener('customInstruction', 'customInstruction', 'input');
        addChangeListener('tempInput', 'temperature', 'input', parseFloat);
        addChangeListener('maxTokensInput', 'maxTokens', 'input', parseInt);

        document.getElementById('fontSizeInput').addEventListener('input', debounce((e) => {
            updateSetting('fontSize', parseInt(e.target.value));
        }, 300));

        document.querySelectorAll('.theme-grid input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    updateSetting('theme', e.target.value);
                }
            });
        });

        document.getElementById('markdownMessages').addEventListener('change', (e) => {
            updateSetting('markdownMessages', e.target.checked);
        });

        document.getElementById('wrapCodeLines').addEventListener('change', (e) => {
            updateSetting('wrapCodeLines', e.target.checked);
        });

        document.getElementById('highContrast').addEventListener('change', (e) => {
            updateSetting('highContrast', e.target.checked);
        });

        document.getElementById('reducedMotion').addEventListener('change', (e) => {
            updateSetting('reducedMotion', e.target.checked);
        });

        document.getElementById('fontSizeInput').addEventListener('input', (e) => {
            updateSetting('fontSize', parseInt(e.target.value));
        });

        document.getElementById('autoOpenSearch').addEventListener('change', (e) => {
            updateSetting('autoOpenSearch', e.target.checked);
        });

        document.getElementById('followUpSuggestions').addEventListener('change', (e) => {
            updateSetting('followUpSuggestions', e.target.checked);
        });

        document.getElementById('autoDetectURLs').addEventListener('change', (e) => {
            updateSetting('autoDetectURLs', e.target.checked);
        });

        document.getElementById('autoScroll').addEventListener('change', (e) => {
            updateSetting('autoScroll', e.target.checked);
        });

        document.getElementById('confirmDelete').addEventListener('change', (e) => {
            updateSetting('confirmDelete', e.target.checked);
        });

        document.getElementById('typingSpeed').addEventListener('input', (e) => {
            updateSetting('typingSpeed', parseInt(e.target.value));
        });

        // Handle radio buttons for responseStyle
        document.querySelectorAll('input[name="responseStyle"]').forEach((radio) => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    updateSetting('responseStyle', e.target.value);
                }
            });
        });

        document.getElementById('customInstruction').addEventListener('input', (e) => {
            updateSetting('customInstruction', e.target.value);
        });

        document.getElementById('tempInput').addEventListener('input', (e) => {
            updateSetting('temperature', parseFloat(e.target.value));
        });

        document.getElementById('maxTokensInput').addEventListener('input', (e) => {
            updateSetting('maxTokens', parseInt(e.target.value));
        });

        elements.settingsModal.addEventListener('click', (e) => {
            if (e.target === elements.settingsModal) {
                utils.toggleElementDisplay(elements.settingsModal, 'none');
            }
        });

        elements.fontSizeInput.addEventListener('input', () => {
            elements.fontSizeValue.textContent = elements.fontSizeInput.value;
        });

        elements.tempInput.addEventListener('input', () => {
            elements.tempValue.textContent = elements.tempInput.value;
        });
        elements.micBtn.addEventListener('click', () => {
            if (state.isRecording) voiceManager.stop();
            else voiceManager.start();
        });

        elements.darkModeBtn.addEventListener('click', () => {
            state.isDarkMode = !state.isDarkMode;
            document.body.classList.toggle('dark-mode', state.isDarkMode);
            localStorage.setItem('darkMode', state.isDarkMode);
            utils.showNotification(`Switched to ${state.isDarkMode ? 'dark' : 'light'} mode.`, 'info');
        });

        elements.chatContainer.addEventListener('click', (e) => {
            const target = e.target;

            // Copy button
            const copyBtn = target.closest('.copy-btn');
            if (copyBtn) {
                const messageDiv = copyBtn.closest('.message');
                const content = messageDiv.querySelector('.markdown-body').textContent;
                navigator.clipboard.writeText(content)
                    .then(() => utils.showNotification('Text copied to clipboard!', 'info'))
                    .catch(err => {
                        console.error('Copy failed:', err);
                        utils.showNotification('Failed to copy text.', 'error');
                    });
                return;
            }

            // Regenerate button
            const regenerateBtn = target.closest('.regenerate-btn');
            if (regenerateBtn) {
                const messageId = regenerateBtn.dataset.id;
                chatManager.regenerateMessage(messageId);
                return;
            }

            // Edit user message button
            const editBtn = target.closest('.edit-btn');
            if (editBtn) {
                chatManager.editMessage(editBtn.dataset.id);
                return;
            }

            // Edit AI message button
            const editAiBtn = target.closest('.edit-ai-btn');
            if (editAiBtn) {
                const messageId = editAiBtn.dataset.id;
                const messageDiv = editAiBtn.closest('.message');
                const contentDiv = messageDiv.querySelector('.markdown-body');
                const originalContent = state.messages.find(m => m.id === messageId).content;
                contentDiv.contentEditable = true;
                contentDiv.classList.add('editable');
                contentDiv.focus();
                contentDiv.addEventListener('blur', async () => {
                    contentDiv.contentEditable = false;
                    contentDiv.classList.remove('editable');
                    const newContent = contentDiv.textContent;
                    if (newContent !== originalContent) {
                        state.messages.find(m => m.id === messageId).content = newContent;
                        await chatManager.saveChat();
                        utils.showNotification('Message updated.', 'info');
                    }
                }, {
                    once: true
                });
                return;
            }

            // Reply button
            const replyBtn = target.closest('.reply-btn');
            if (replyBtn) {
                const parentId = replyBtn.dataset.id;
                const message = state.messages.find(m => m.id === parentId);
                if (!message) return;

                elements.messageInput.dataset.parentId = parentId;
                elements.inputContainer.classList.add('replying');
                elements.messageInput.focus();

                let replyIndicator = elements.inputContainer.querySelector('.reply-indicator');
                if (!replyIndicator) {
                    replyIndicator = document.createElement('div');
                    replyIndicator.className = 'reply-indicator';
                    elements.inputContainer.insertBefore(replyIndicator, elements.inputContainer.firstChild);
                }
                replyIndicator.textContent = `Replying to: ${message.content.slice(0, 20)}${message.content.length > 20 ? '...' : ''}`;
                return;
            }
        });

        elements.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const parentId = elements.messageInput.dataset.parentId;
                chatManager.sendMessage(elements.messageInput.value.trim(), parentId);
                if (parentId) {
                    delete elements.messageInput.dataset.parentId;
                    elements.inputContainer.classList.remove('replying');
                    const replyIndicator = elements.inputContainer.querySelector('.reply-indicator');
                    if (replyIndicator) replyIndicator.remove();
                }
            }
        });

        elements.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && elements.messageInput.dataset.parentId) {
                delete elements.messageInput.dataset.parentId;
                elements.inputContainer.classList.remove('replying');
                const replyIndicator = elements.inputContainer.querySelector('.reply-indicator');
                if (replyIndicator) replyIndicator.remove();
            }
        });

        document.addEventListener('click', (e) => {
            if (!elements.inputContainer.contains(e.target) && elements.messageInput.dataset.parentId) {
                delete elements.messageInput.dataset.parentId;
                elements.inputContainer.classList.remove('replying');
                const replyIndicator = elements.inputContainer.querySelector('.reply-indicator');
                if (replyIndicator) replyIndicator.remove();
            }
        });

        elements.chatContainer.addEventListener('scroll', () => {
            const scrollOffset = elements.chatContainer.scrollTop;
            const isScrolledUp = scrollOffset < elements.chatContainer.scrollHeight - elements.chatContainer.clientHeight - 0; // Show if scrolled up > 300px
            elements.scrollToBottomBtn.style.display = isScrolledUp ? 'flex' : 'none';
        });

        elements.scrollToBottomBtn.addEventListener('click', utils.scrollToBottom);

        elements.exampleButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                elements.messageInput.value = btn.dataset.prompt;
                chatManager.sendMessage(elements.messageInput.value);
            });
        });

        let searchTimeout;
        elements.historySearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            chatManager.updateHistoryList(searchTerm); // Pass search term directly
        });

        elements.clearHistoryBtn.addEventListener('click', chatManager.clearHistory);

        elements.sortToggleBtn.addEventListener('click', () => {
            state.sortMode = state.sortMode === 'date' ? 'alpha' : 'date';
            chatManager.updateHistoryList();
            utils.showNotification(`Sorted by ${state.sortMode === 'date' ? 'date' : 'alphabetical order'}`, 'info');
        });

        document.addEventListener('DOMContentLoaded', () => {
            const profileSection = document.createElement('div');
            profileSection.id = 'sidebar-profile';
            profileSection.innerHTML = `
            <div class="profile-item">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span>${state.user ? state.user.email : 'User'}</span>
            </div>
            <div class="profile-dropdown">
                <button id="dropdownSettingsBtn">Settings</button>
                <button id="dropdownLogoutBtn">Logout</button>
            </div>
        `;
            elements.sidebar.appendChild(profileSection);

            const dropdown = profileSection.querySelector('.profile-dropdown');
            profileSection.querySelector('.profile-item').addEventListener('click', () => {
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });
            document.addEventListener('click', (e) => {
                if (!profileSection.contains(e.target)) dropdown.style.display = 'none';
            });
            profileSection.querySelector('#dropdownSettingsBtn').addEventListener('click', () => {
                utils.toggleElementDisplay(elements.settingsModal, 'flex');
                dropdown.style.display = 'none';
            });
            profileSection.querySelector('#dropdownLogoutBtn').addEventListener('click', () => {
                auth.signOut();
                dropdown.style.display = 'none';
            });

            chatManager.resetApiKeyUsage();
            elements.messageInput.focus();
        });
    </script>
</body>

</html>
