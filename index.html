<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #fff;
            color: #000;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding-top: none;
            padding-bottom: 80px;
            /* Space for bottom nav */
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 10px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
            z-index: 20;
            border-sizing: border-box;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .action-btn:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }

        .action-btn svg {
            width: 24px;
            height: 24px;
            color: #000;
        }

        .container {
            margin: 0 auto;
            position: relative;
            transition: margin-bottom 0.3s ease;
            padding: 0;
            padding-top: 100px;
        }

        .tab-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 0 0 12px 12px;
            /* Rounded bottom corners only */
            backdrop-filter: blur(12px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            position: fixed;
            /* Changed from sticky to fixed */
            top: 0px;
            /* Aligns to the top of the viewport */
            left: 0;
            width: 100%;
            z-index: 10;
            border-sizing: border-box;
            width: 100%;
            /* Keeps it centered and compact */
            margin: 0 auto;
            /* Centers horizontally */
            transform: translateY(-100%);
            /* Start off-screen */
            animation: slideDown 0.5s ease forwards;
            /* Smooth entry animation */
        }

        /* Animation for sliding down */
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0%);
            }
        }

        .tab-btn {
            padding: 15px 16px;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: 500;
            color: #6e6e73;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .tab-btn.active {
            color: #000;
            font-weight: 600;
        }

        .tab-btn:hover {
            transform: scale(1.05);
        }

        .poll {
            background: #fff;
            margin-bottom: 40px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            padding: 20px;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: slideIn 0.5s ease forwards;
        }

        .poll-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #000;
            font-size: 1.4em;
        }

        .user-container {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            color: #6e6e73;
            font-size: 0.9em;
        }

        .user-circle {
            background: #000;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            width: 28px;
            height: 28px;
            margin-right: 8px;
        }

        .option {
            padding: 12px 16px;
            margin: 6px 0;
            background: #f5f5f5;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .option.voted {
            background: #e5e5e5;
            transform: scale(1.02);
        }

        .option.highest {
            background: #e0e0e0;
        }

        .option:hover:not(.voted) {
            background: #e8e8e8;
            transform: scale(1.02);
        }

        .option:active:not(.voted) {
            transform: scale(0.98);
        }

        .vote-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #6e6e73;
            opacity: 0.3;
            transition: width 0.4s ease;
        }

        .vote-bar.highest {
            background: #000;
        }

        .option-text {
            position: relative;
            z-index: 1;
            font-weight: 400;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            animation: modalPop 0.3s ease forwards;
        }

        input,
        button {
            width: 100%;
            margin: 8px 0;
            padding: 12px;
            border: none;
            background: #f5f5f5;
            color: #000;
            border-radius: 10px;
            font-size: 1em;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        input:focus {
            background: #e8e8e8;
            outline: none;
        }

        button {
            background: #000;
            color: #fff;
            cursor: pointer;
        }

        button:hover {
            
            transform: scale(1.02);
        }

        .secondary-btn {
            background: #f5f5f5;
            color: #000;
        }

        .secondary-btn:hover {
            background: #e5e5e5;
        }

        .loader {
            border: 3px solid #e8e8e8;
            border-top: 3px solid #000;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        .tag {
            background: #e8e8e8;
            padding: 4px 8px;
            border-radius: 8px;
            color: #6e6e73;
            font-size: 0.85em;
            margin-left: 8px;
        }

        .timer,
        .poll-stats {
            color: #6e6e73;
            margin-top: 8px;
            font-size: 0.85em;
        }

        .no-polls {
            text-align: center;
            color: #6e6e73;
            font-weight: 500;
            font-size: 1.1em;
            margin-top: 20px;
        }

        .menu-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            width: 30px;
            height: 30px;
            transition: transform 0.2s ease;
        }

        .menu-btn:hover {
            transform: scale(1.1);
        }

        .menu-btn svg {
            width: 20px;
            height: 20px;
            color: #000;
        }

        .context-menu {
            display: none;
            position: absolute;
            top: 40px;
            right: 12px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 30;
            min-width: 160px;
            transform: scale(0.95);
            opacity: 0;
            animation: menuPop 0.2s ease forwards;
        }

        .context-menu button {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: none;
            color: #000;
            font-size: 0.9em;
            border-radius: 0;
            transition: background 0.2s ease;
        }

        .context-menu button:hover {
            background: #f5f5f5;
            scale: 1;
        }

        .context-menu button svg {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        .load-more-btn {
            position: fixed;
            bottom: -60px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            transition: bottom 0.3s ease, transform 0.2s ease;
            z-index: 50;
        }

        .load-more-btn.visible {
            bottom: 80px;
        }

        /* Above bottom nav */
        .load-more-btn:hover {
            transform: translateX(-50%) scale(1.05);
        }

        /* Mobile Styles */
        @media (max-width: 767px) {
            body {
                padding: 16px;
                padding-bottom: 80px;
            }

            .container {
                padding-top: 80px;
            }

            .tab-bar {
                top: 0;
                padding: 8px 16px;
            }

            .poll {
                padding: 16px;
                margin-bottom: 16px;
            }

            .poll-title {
                font-size: 1.3em;
            }

            .user-circle {
                width: 24px;
                height: 24px;
                font-size: 0.9em;
                margin-right: 6px;
            }

            .user-container {
                font-size: 0.85em;
            }

            .option {
                padding: 10px 12px;
                font-size: 0.9em;
            }

            .modal-content {
                padding: 16px;
                width: 90%;
                max-width: 340px;
            }

            .bottom-nav {
                padding: 8px 0;
            }

            .action-btn {
                padding: 8px;
            }

            .action-btn svg {
                width: 20px;
                height: 20px;
            }

            .load-more-btn.visible {
                bottom: 70px;
            }
        }

        /* Desktop Styles */
        @media (min-width: 768px) {
            body {
                padding: 32px;
                padding-bottom: 80px;
            }

            .container {
                max-width: 800px;
                padding-top: 80px;
            }

            .tab-bar {
                top: 0;
            }

            .poll {
                padding: 20px;
            }

            .poll-title {
                font-size: 1.6em;
            }

            .user-circle {
                width: 32px;
                height: 32px;
                font-size: 1.1em;
            }

            .user-container {
                font-size: 0.95em;
            }

            .option {
                padding: 12px 16px;
                font-size: 1em;
            }

            .modal-content {
                padding: 24px;
                max-width: 480px;
            }
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes modalPop {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes menuPop {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Dark Mode */
        .dark body {
            background: #000;
            color: #fff;
        }

        .dark .bottom-nav {
            background: rgba(0, 0, 0, 0.95);
            box-shadow: 0 -2px 8px rgba(255, 255, 255, 0.05);
        }

        .dark .action-btn {
            background: none;
        }

        .dark .action-btn:hover {
            opacity: 0.8;
        }

        .dark .tab-bar {
            background: rgba(0, 0, 0, 0.95);
            box-shadow: 0 2px 6px rgba(255, 255, 255, 0.05);
        }

        .dark .poll {
            background: #1a1a1a;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
        }

        .dark .option {
            background: #333;
        }

        .dark .option.voted {
            background: #444;
        }

        .dark .option.highest {
            background: #555;
        }

        .dark .option:hover:not(.voted) {
            background: #444;
        }

        .dark .modal-content {
            background: #1a1a1a;
        }

        .dark input,
        .dark button {
            background: #333;
            color: #fff;
        }

        .dark input:focus {
            background: #444;
        }

        .dark button {
            background: #fff;
            color: #000;
        }

        .dark button:hover {
            background: #e5e5e5;
        }

        .dark .secondary-btn {
            background: #333;
            color: #fff;
        }

        .dark .secondary-btn:hover {
            background: #444;
        }

        .dark .context-menu {
            background: #1a1a1a;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
        }

        .dark .context-menu button {
            color: #fff;
        }

        .dark .context-menu button:hover {
            background: #333;
        }

        .dark .load-more-btn {
            background: #fff;
            color: #000;
        }

        .dark .load-more-btn:hover {
            background: #e5e5e5;
        }
    </style>
</head>

<body>
    <div class="tab-bar" id="tabBar"></div>
    <div class="container" id="activePollsContainer"></div>
    <div class="container" id="votedPollsContainer" style="display: none;"></div>
    <div class="container" id="myPollsContainer" style="display: none;"></div>
    <div class="modal" id="authModal">
        <div class="modal-content">
            <h2>Sign In or Up</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="App.loginOrSignup()">Submit</button>
            <button class="secondary-btn" onclick="App.closeModal()">Cancel</button>
        </div>
    </div>
    <div class="modal" id="createPollModal">
        <div class="modal-content">
            <h2>Create Poll</h2>
            <input type="text" id="pollQuestion" placeholder="Question">
            <input type="text" id="option1" placeholder="Option 1">
            <input type="text" id="option2" placeholder="Option 2">
            <input type="text" id="option3" placeholder="Option 3 (optional)">
            <input type="text" id="option4" placeholder="Option 4 (optional)">
            <input type="text" id="pollTags" placeholder="Tags (e.g., fun, school)">
            <input type="number" id="pollTimer" placeholder="Expiration (hours)">
            <button onclick="App.submitPoll()">Create</button>
            <button class="secondary-btn" onclick="App.closeModal()">Cancel</button>
        </div>
    </div>
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <h2>Profile</h2>
            <p id="userNameDisplay"></p>
            <input type="text" id="newUserName" placeholder="New Username">
            <button onclick="App.updateUserName()">Update</button>
            <button onclick="App.toggleDarkMode()">Dark Mode</button>
            <button onclick="App.exportData()">Export Data</button>
            <button class="secondary-btn" onclick="App.logout()">Logout</button>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <h2>Stats</h2>
            <p id="statsDisplay"></p>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <h2>Report Poll</h2>
            <input type="text" id="reportReason" placeholder="Reason for reporting">
            <button onclick="App.submitReport()">Submit</button>
            <button class="secondary-btn" onclick="App.closeModal()">Cancel</button>
        </div>
    </div>
    <div class="loader" id="loader"></div>
    <button class="load-more-btn" id="loadMoreBtn" onclick="App.loadMorePoll()">Load More</button>
    <div class="bottom-nav">
        <button class="action-btn" onclick="App.showStats()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        </button>
        <button class="action-btn" onclick="App.showProfile()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        </button>
        <button class="action-btn" onclick="App.showCreatePoll()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
        </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAGCBoD6Cn7lnTD8R-sQHBTE5IdFVq0hBA",
            authDomain: "nglhonestly.firebaseapp.com",
            databaseURL: "https://nglhonestly-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nglhonestly",
            storageBucket: "nglhonestly.firebasestorage.app",
            messagingSenderId: "1002591277776",
            appId: "1:1002591277776:web:9f71be9c14642a188744d5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Application State
        const state = {
            currentUser: null,
            activeTab: 'active',
            polls: {},
            votedPolls: JSON.parse(localStorage.getItem('votedPolls') || '[]'),
            createdPolls: JSON.parse(localStorage.getItem('createdPolls') || '[]'),
            bookmarks: JSON.parse(localStorage.getItem('bookmarks') || '[]'),
            voteStreak: parseInt(localStorage.getItem('voteStreak') || '0'),
            darkMode: localStorage.getItem('darkMode') === 'true'
        };

        // UI Utilities
        const UI = {
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
                    padding: 8px 16px; background: ${type === 'error' ? '#ff3b30' : '#000'};
                    color: #fff; border-radius: 10px; z-index: 1000; font-size: 0.9em;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); opacity: 0; transition: opacity 0.3s ease;
                `;
                document.body.appendChild(toast);
                requestAnimationFrame(() => {
                    toast.style.opacity = '1';
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                });
            },

            toggleLoader(show) {
                document.getElementById('loader').style.display = show ? 'block' : 'none';
            },

            showModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            },

            hideModals() {
                document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
            },

            updateTabBar() {
                const tabBar = document.getElementById('tabBar');
                tabBar.innerHTML = state.currentUser ? `
                    <button class="tab-btn ${state.activeTab === 'active' ? 'active' : ''}" onclick="App.switchTab('active')">Active</button>
                    <button class="tab-btn ${state.activeTab === 'voted' ? 'active' : ''}" onclick="App.switchTab('voted')">Voted</button>
                    <button class="tab-btn ${state.activeTab === 'my' ? 'active' : ''}" onclick="App.switchTab('my')">My Polls</button>
                ` : `
                    <button class="tab-btn ${state.activeTab === 'active' ? 'active' : ''}" onclick="App.switchTab('active')">Active</button>
                    <button class="tab-btn ${state.activeTab === 'voted' ? 'active' : ''}" onclick="App.switchTab('voted')">Voted</button>
                `;
            },

            updateProfileDisplay() {
                if (!state.currentUser) return;
                db.collection('users').doc(state.currentUser.uid).get()
                    .then(doc => {
                        const username = doc.exists ? doc.data().username : 'Not set';
                        document.getElementById('userNameDisplay').textContent = username;
                    })
                    .catch(err => UI.showToast(`Profile error: ${err.message}`, 'error'));
            }
        };

        // Application Logic
        const App = {
            async init() {
                firebase.auth().onAuthStateChanged(user => {
                    state.currentUser = user;
                    UI.updateTabBar();
                    if (user) {
                        UI.updateProfileDisplay();
                        UI.showToast('Signed in!');
                    } else {
                        document.getElementById('activePollsContainer').innerHTML = '<div class="no-polls">Sign in to start.</div>';
                        document.getElementById('votedPollsContainer').innerHTML = '';
                        document.getElementById('myPollsContainer').innerHTML = '';
                    }
                    this.loadPolls(true);
                    if (state.darkMode) document.body.classList.add('dark');
                });
            },

            switchTab(tab) {
                state.activeTab = tab;
                const containers = {
                    active: 'activePollsContainer',
                    voted: 'votedPollsContainer',
                    my: 'myPollsContainer'
                };
                Object.values(containers).forEach(id => {
                    document.getElementById(id).style.display = id === containers[tab] ? 'block' : 'none';
                });
                UI.updateTabBar();
                if (tab === 'active') this.loadPolls();
                else if (tab === 'voted') this.loadVotedPolls();
                else this.loadMyPolls();
            },

            async loadPolls(isInitial = false) {
                const activeContainer = document.getElementById('activePollsContainer');
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                UI.toggleLoader(true);

                try {
                    const snapshot = await rtdb.ref('polls').once('value');
                    const polls = snapshot.val() || {};
                    state.polls = polls;

                    const pollIds = Object.keys(polls).filter(id => !polls[id].expires || polls[id].expires > Date.now());
                    if (!pollIds.length) {
                        activeContainer.innerHTML = '<div class="no-polls">No active polls.</div>';
                        UI.toggleLoader(false);
                        return;
                    }

                    const availableIds = this.filterAvailablePolls(pollIds);
                    if (!availableIds.length) {
                        activeContainer.innerHTML = '<div class="no-polls">All voted! Check your polls.</div>';
                        UI.toggleLoader(false);
                        return;
                    }

                    const randomId = availableIds[Math.floor(Math.random() * availableIds.length)];
                    if (isInitial) activeContainer.innerHTML = '';
                    this.renderPoll(polls[randomId], randomId, activeContainer);

                    if (state.votedPolls.includes(randomId)) {
                        loadMoreBtn.classList.add('visible');
                    } else {
                        loadMoreBtn.classList.remove('visible');
                    }

                    const latestPoll = activeContainer.lastElementChild;
                    if (latestPoll) {
                        const screenHeight = window.innerHeight;
                        const pollHeight = latestPoll.offsetHeight;
                        const marginBottom = (screenHeight - pollHeight) / 2;
                        activeContainer.style.marginBottom = `${marginBottom}px`;
                        setTimeout(() => activeContainer.style.marginBottom = '20px', 3100);
                    }

                    setTimeout(() => window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    }), 100);
                } catch (err) {
                    activeContainer.innerHTML = `<div class="no-polls">Error: ${err.message}</div>`;
                    UI.showToast(`Error: ${err.message}`, 'error');
                } finally {
                    UI.toggleLoader(false);
                }
            },

            loadMorePoll() {
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                loadMoreBtn.classList.remove('visible');
                setTimeout(() => this.loadPolls(false), 300);
            },

            async loadVotedPolls() {
                const votedContainer = document.getElementById('votedPollsContainer');
                UI.toggleLoader(true);

                try {
                    const snapshot = await rtdb.ref('polls').once('value');
                    const polls = snapshot.val() || {};
                    if (!state.votedPolls.length) {
                        votedContainer.innerHTML = '<div class="no-polls">No voted polls.</div>';
                        return;
                    }

                    votedContainer.innerHTML = '';
                    state.votedPolls.forEach(pollId => {
                        if (polls[pollId] && (!polls[pollId].expires || polls[pollId].expires > Date.now())) {
                            this.renderPoll(polls[pollId], pollId, votedContainer, true);
                        }
                    });
                } catch (err) {
                    votedContainer.innerHTML = `<div class="no-polls">Error: ${err.message}</div>`;
                    UI.showToast(`Error: ${err.message}`, 'error');
                } finally {
                    UI.toggleLoader(false);
                }
            },

            async loadMyPolls() {
                if (!state.currentUser) return;
                const myContainer = document.getElementById('myPollsContainer');
                UI.toggleLoader(true);

                try {
                    const snapshot = await rtdb.ref('polls').once('value');
                    const polls = snapshot.val() || {};
                    const myPollIds = Object.keys(polls).filter(id => polls[id].creatorId === state.currentUser.uid && (!polls[id].expires || polls[id].expires > Date.now()));

                    if (!myPollIds.length) {
                        myContainer.innerHTML = '<div class="no-polls">No active polls by you.</div>';
                        return;
                    }

                    myContainer.innerHTML = '';
                    myPollIds.forEach(pollId => this.renderPoll(polls[pollId], pollId, myContainer, false, true));
                } catch (err) {
                    myContainer.innerHTML = `<div class="no-polls">Error: ${err.message}</div>`;
                    UI.showToast(`Error: ${err.message}`, 'error');
                } finally {
                    UI.toggleLoader(false);
                }
            },

            filterAvailablePolls(pollIds) {
                let availableIds = pollIds.filter(id => !state.votedPolls.includes(id));
                if (state.currentUser) {
                    availableIds = availableIds.filter(id => state.polls[id].creatorId !== state.currentUser.uid);
                    if (!availableIds.length) {
                        availableIds = pollIds.filter(id => !state.votedPolls.includes(id));
                    }
                }
                return availableIds;
            },

            renderPoll(poll, pollId, container, isVoted = false, isMine = false) {
                const hasVoted = state.votedPolls.includes(pollId);
                const userVote = localStorage.getItem(`vote_${pollId}`);
                const pollDiv = document.createElement('div');
                pollDiv.className = 'poll';

                const userName = poll.userName || 'Unknown';
                pollDiv.innerHTML = `
                    <div class="poll-title">${poll.question || 'Untitled'}</div>
                    <div class="user-container">
                        <div class="user-circle">${userName.charAt(0).toUpperCase()}</div>
                        <div>${userName}${poll.tags ? `<span class="tag">${poll.tags}</span>` : ''}</div>
                    </div>
                    ${poll.expires ? `<div class="timer">Expires in ${Math.ceil((poll.expires - Date.now()) / 3600000)}h</div>` : ''}
                `;

                const optionsDiv = document.createElement('div');
                const totalVotes = Object.values(poll.options || {}).reduce((sum, votes) => sum + votes, 0);
                const highestVote = Math.max(...Object.values(poll.options || {}));

                Object.keys(poll.options || {}).forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = `option ${userVote === option ? 'voted' : ''} ${poll.options[option] === highestVote && hasVoted ? 'highest' : ''}`;
                    const votes = poll.options[option] || 0;
                    const percentage = totalVotes ? (votes / totalVotes) * 100 : 0;
                    optionDiv.innerHTML = `
                        <div class="vote-bar ${poll.options[option] === highestVote && hasVoted ? 'highest' : ''}" style="width: ${hasVoted ? percentage : 0}%;"></div>
                        <div class="option-text">${option}${hasVoted ? ` (${votes}, ${percentage.toFixed(1)}%)` : ''}${userVote === option ? ' (You)' : ''}</div>
                    `;
                    if (!hasVoted) optionDiv.onclick = () => this.vote(pollId, option, optionsDiv, pollDiv);
                    optionsDiv.appendChild(optionDiv);
                });

                rtdb.ref(`polls/${pollId}/options`).on('value', snapshot => {
                    if (snapshot.val()) this.updateVotes(snapshot.val(), optionsDiv, hasVoted);
                });

                const statsDiv = document.createElement('div');
                statsDiv.className = 'poll-stats';
                statsDiv.textContent = `Votes: ${totalVotes} â€¢ ${new Date(poll.createdAt).toLocaleDateString()}`;
                pollDiv.appendChild(statsDiv);

                const menuBtn = document.createElement('button');
                menuBtn.className = 'menu-btn';
                menuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>`;
                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.innerHTML = `
                    <button onclick="App.sharePoll('${pollId}', '${poll.question}')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                        Share
                    </button>
                    ${hasVoted ? `<button onclick="App.unvote('${pollId}', this.closest('.poll'))"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>Unvote</button>` : ''}
                    ${isMine ? `<button onclick="App.deletePoll('${pollId}', this.closest('.poll'))"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Delete</button>` : ''}
                    <button onclick="App.bookmarkPoll('${pollId}')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>
                        Bookmark
                    </button>
                    <button onclick="App.showReportModal('${pollId}')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        Report
                    </button>
                `;
                menuBtn.onclick = e => {
                    e.stopPropagation();
                    contextMenu.style.display = contextMenu.style.display === 'block' ? 'none' : 'block';
                };
                document.addEventListener('click', () => contextMenu.style.display = 'none');
                pollDiv.appendChild(menuBtn);
                pollDiv.appendChild(contextMenu);
                pollDiv.appendChild(optionsDiv);
                container.appendChild(pollDiv);
            },

            updateVotes(options, optionsDiv, hasVoted) {
                const totalVotes = Object.values(options).reduce((sum, votes) => sum + votes, 0);
                const highestVote = Math.max(...Object.values(options));
                Array.from(optionsDiv.children).forEach(optionDiv => {
                    if (optionDiv.classList.contains('option')) {
                        const optionText = optionDiv.querySelector('.option-text').textContent.split(' (')[0];
                        const votes = options[optionText] || 0;
                        const percentage = totalVotes ? (votes / totalVotes) * 100 : 0;
                        if (hasVoted) {
                            optionDiv.querySelector('.vote-bar').style.width = `${percentage}%`;
                            optionDiv.querySelector('.option-text').textContent = `${optionText} (${votes}, ${percentage.toFixed(1)}%)`;
                            optionDiv.classList.toggle('highest', votes === highestVote);
                            optionDiv.querySelector('.vote-bar').classList.toggle('highest', votes === highestVote);
                            optionDiv.onclick = null;
                        }
                    }
                });
            },

            async vote(pollId, selectedOption, optionsDiv, pollDiv) {
                state.votedPolls.push(pollId);
                localStorage.setItem(`voted_${pollId}`, 'true');
                localStorage.setItem(`vote_${pollId}`, selectedOption);
                localStorage.setItem('votedPolls', JSON.stringify(state.votedPolls));

                try {
                    await rtdb.ref(`polls/${pollId}/options/${selectedOption}`).transaction(votes => (votes || 0) + 1);
                    state.voteStreak++;
                    localStorage.setItem('voteStreak', state.voteStreak);
                    if (state.voteStreak % 5 === 0) UI.showToast(`Streak: ${state.voteStreak}!`);

                    const snapshot = await rtdb.ref(`polls/${pollId}`).once('value');
                    const updatedPoll = snapshot.val();
                    pollDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    pollDiv.style.opacity = '0';
                    pollDiv.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        pollDiv.innerHTML = '';
                        this.renderPoll(updatedPoll, pollId, pollDiv.parentElement, true, state.currentUser && updatedPoll.creatorId === state.currentUser.uid);
                    }, 300);

                    UI.showToast('Voted! Next in 3s...');
                    setTimeout(() => this.loadPolls(), 3000);
                } catch (err) {
                    state.votedPolls = state.votedPolls.filter(id => id !== pollId);
                    localStorage.removeItem(`voted_${pollId}`);
                    localStorage.removeItem(`vote_${pollId}`);
                    localStorage.setItem('votedPolls', JSON.stringify(state.votedPolls));
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            async unvote(pollId, pollDiv) {
                const userVote = localStorage.getItem(`vote_${pollId}`);
                if (!userVote) {
                    UI.showToast('No vote to remove.', 'error');
                    return;
                }

                try {
                    await rtdb.ref(`polls/${pollId}/options/${userVote}`).transaction(votes => (votes || 1) - 1 >= 0 ? (votes || 1) - 1 : 0);
                    state.votedPolls = state.votedPolls.filter(id => id !== pollId);
                    localStorage.removeItem(`voted_${pollId}`);
                    localStorage.removeItem(`vote_${pollId}`);
                    localStorage.setItem('votedPolls', JSON.stringify(state.votedPolls));
                    UI.showToast('Vote removed!');
                    const snapshot = await rtdb.ref(`polls/${pollId}`).once('value');
                    const updatedPoll = snapshot.val();
                    pollDiv.innerHTML = '';
                    this.renderPoll(updatedPoll, pollId, pollDiv.parentElement, false, state.currentUser && updatedPoll.creatorId === state.currentUser.uid);
                    this.loadVotedPolls();
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            async deletePoll(pollId, pollDiv) {
                if (!confirm('Delete this poll?')) return;
                try {
                    await rtdb.ref(`polls/${pollId}`).remove();
                    pollDiv.style.transition = 'opacity 0.3s ease';
                    pollDiv.style.opacity = '0';
                    setTimeout(() => pollDiv.remove(), 300);
                    UI.showToast('Poll deleted!');
                    this.loadPolls();
                    this.loadVotedPolls();
                    this.loadMyPolls();
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            sharePoll(pollId, question) {
                const url = `zandenkoh.github.io/pollen/?poll=${pollId}`;
                navigator.clipboard.writeText(`${question} - ${url}`)
                    .then(() => UI.showToast('Copied!'))
                    .catch(() => UI.showToast('Copy failed', 'error'));
            },

            bookmarkPoll(pollId) {
                if (!state.bookmarks.includes(pollId)) {
                    state.bookmarks.push(pollId);
                    localStorage.setItem('bookmarks', JSON.stringify(state.bookmarks));
                    UI.showToast('Bookmarked!');
                } else {
                    UI.showToast('Already bookmarked!');
                }
            },

            showReportModal(pollId) {
                UI.showModal('reportModal');
                document.getElementById('reportReason').dataset.pollId = pollId;
            },

            async submitReport() {
                const reason = document.getElementById('reportReason').value.trim();
                const pollId = document.getElementById('reportReason').dataset.pollId;
                if (!reason) {
                    UI.showToast('Reason required', 'error');
                    return;
                }
                try {
                    await db.collection('reports').add({
                        pollId,
                        userId: state.currentUser.uid,
                        reason,
                        timestamp: Date.now()
                    });
                    UI.showToast('Reported!');
                    UI.hideModals();
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            showCreatePoll() {
                state.currentUser ? UI.showModal('createPollModal') : UI.showModal('authModal');
            },

            showProfile() {
                state.currentUser ? UI.showModal('profileModal') : UI.showModal('authModal');
            },

            showStats() {
                if (!state.currentUser) {
                    UI.showToast('Sign in first.', 'error');
                    return;
                }
                UI.showModal('statsModal');
                document.getElementById('statsDisplay').innerHTML = `
                    Voted: ${state.votedPolls.length}<br>
                    Streak: ${state.voteStreak}<br>
                    Created: ${state.createdPolls.length}<br>
                    Bookmarks: ${state.bookmarks.length}<br>
                    Fact: ${this.getRandomFact()}
                `;
            },

            getRandomFact() {
                const facts = ['Polls began in 1824.', 'Fastest poll: 3s.', '80% enjoy polls!', '"Poll" from "head".'];
                return facts[Math.floor(Math.random() * facts.length)];
            },

            closeModal() {
                UI.hideModals();
            },

            async loginOrSignup() {
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value.trim();
                if (!email || !password) {
                    UI.showToast('Email and password required.', 'error');
                    return;
                }

                try {
                    let userCredential;
                    try {
                        userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                    } catch {
                        userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                        const name = prompt('Pick a username:')?.trim();
                        if (!name) throw new Error('Username required');
                        await db.collection('users').doc(userCredential.user.uid).set({
                            uid: userCredential.user.uid,
                            username: name,
                            email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    UI.hideModals();
                    this.loadPolls(true);
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            async submitPoll() {
                if (!state.currentUser) {
                    UI.showToast('Sign in first.', 'error');
                    return;
                }

                const question = document.getElementById('pollQuestion').value.trim();
                const options = [
                    document.getElementById('option1').value.trim(),
                    document.getElementById('option2').value.trim(),
                    document.getElementById('option3').value.trim(),
                    document.getElementById('option4').value.trim()
                ].filter(opt => opt);
                const tags = document.getElementById('pollTags').value.trim();
                const timer = document.getElementById('pollTimer').value.trim();

                if (!question || options.length < 2) {
                    UI.showToast('Question + 2 options required.', 'error');
                    return;
                }

                try {
                    const doc = await db.collection('users').doc(state.currentUser.uid).get();
                    if (!doc.exists) throw new Error('User not found');
                    const userName = doc.data().username || 'Unknown';
                    const poll = {
                        question,
                        userName,
                        options: options.reduce((acc, opt) => ({
                            ...acc,
                            [opt]: 0
                        }), {}),
                        tags: tags || null,
                        expires: timer ? Date.now() + (parseInt(timer) * 3600000) : null,
                        createdAt: Date.now(),
                        creatorId: state.currentUser.uid,
                        category: tags ? tags.split(',')[0].trim() : 'General'
                    };
                    const ref = await rtdb.ref('polls').push(poll);
                    state.createdPolls.push(ref.key);
                    localStorage.setItem('createdPolls', JSON.stringify(state.createdPolls));
                    UI.showToast('Poll created!');
                    UI.hideModals();
                    this.loadPolls();
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            async updateUserName() {
                const newName = document.getElementById('newUserName').value.trim();
                if (!newName) {
                    UI.showToast('Enter a username.', 'error');
                    return;
                }
                try {
                    await db.collection('users').doc(state.currentUser.uid).update({
                        username: newName
                    });
                    UI.updateProfileDisplay();
                    UI.showToast('Updated!');
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            async logout() {
                try {
                    await firebase.auth().signOut();
                    state.voteStreak = 0;
                    localStorage.setItem('voteStreak', '0');
                    UI.showToast('Signed out!');
                    UI.hideModals();
                    this.loadPolls(true);
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            toggleDarkMode() {
                state.darkMode = !state.darkMode;
                document.body.classList.toggle('dark', state.darkMode);
                localStorage.setItem('darkMode', state.darkMode);
                UI.showToast('Mode toggled!');
            },

            exportData() {
                const data = {
                    votedPolls: state.votedPolls,
                    createdPolls: state.createdPolls,
                    bookmarks: state.bookmarks,
                    streak: state.voteStreak
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pollen_data.json';
                a.click();
                URL.revokeObjectURL(url);
                UI.showToast('Data exported!');
            }
        };

        // Initialize App
        App.init();
    </script>
</body>

</html>
