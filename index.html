<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollen</title>
    <link rel="icon" type="image/png" href="https://st.hzcdn.com/fimgs/c441f4e908cafd4e_1420-w320-h320-b1-p10--contemporary-wall-letters.jpg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #fff;
            color: #000;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding-top: none;
            padding-bottom: 80px;
            /* Space for bottom nav */
        }

        .dark .poll-action-btn {
            background: #333;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 10px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
            z-index: 20;
            border-sizing: border-box;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .action-btn:hover {
            transform: scale(1.1);
            opacity: 0.8;
        }

        .action-btn svg {
            width: 24px;
            height: 24px;
            color: #000;
        }

        .container {
            margin: 0 auto;
            position: relative;
            transition: margin-bottom 0.3s ease;
            padding: 0;
            padding-top: 120px;
        }

        .tab-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 0 0 12px 12px;
            /* Rounded bottom corners only */
            backdrop-filter: blur(12px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            position: fixed;
            /* Changed from sticky to fixed */
            top: 0px;
            /* Aligns to the top of the viewport */
            left: 0;
            width: 100%;
            z-index: 10;
            border-sizing: border-box;
            width: 100%;
            /* Keeps it centered and compact */
            margin: 0 auto;
            /* Centers horizontally */
            transform: translateY(-100%);
            /* Start off-screen */
            animation: slideDown 0.5s ease forwards;
            /* Smooth entry animation */
        }

        /* Animation for sliding down */
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0%);
            }
        }

        .tab-btn {
            padding: 15px 16px;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: 500;
            color: #6e6e73;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .tab-btn.active {
            color: #000;
            font-weight: 600;
        }

        .tab-btn:hover {
            transform: scale(1.05);
        }

        .poll {
            background: #fff;
            margin-bottom: 50px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            padding: 20px;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: slideIn 0.5s ease forwards;
        }

        .poll-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #000;
            font-size: 1.4em;
        }

        .user-container {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            color: #6e6e73;
            font-size: 0.9em;
        }

        .user-circle {
            background: #000;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            width: 28px;
            height: 28px;
            margin-right: 8px;
        }

        .option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Ensure content spreads out */
            padding: 12px 16px;
            margin: 6px 0;
            background: #f5f5f5;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            opacity: 1;
            transition: background 0.3s ease, transform 0.2s ease, opacity 0.2s ease;
        }

        .option-text {
            flex-grow: 1;
            /* Takes up available space */
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
        }

        .option-percentage {
            margin-left: 10px;
            /* Space between text/tick and percentage */
            font-size: 0.9em;
            color: #6e6e73;
            z-index: 1;
            /* Ensure it’s above the vote-bar */
        }

        .tick-icon {
            width: 20px;
            height: 20px;
            margin-left: 8px;
            color: #fff;
            /* White for contrast on voted option */
            z-index: 1;
        }

        .dark .tick-icon {
            color: #000;
            /* Black for dark mode voted option */
        }

        .option.voted .tick-icon {
            display: inline-block;
        }

        .option:not(.voted) .tick-icon {
            display: none;
            /* Hide tick if not voted */
        }

        .vote-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #e2e2e2;
            /* Default background for unvoted options */
            transition: width 0.4s ease;
            z-index: 0;
            color: #a0a0a0;
            border-radius: 0 10px 10px 0;
        }

        /* When the option is voted but not the highest */
        .option.voted .vote-bar {
            background: #e2e2e2;
            /* Black for voted options */
            opacity: 1;
            /* Full opacity for voted */
            color: #000;
        }

        /* When the option is both voted and the highest */
        .option.voted.highest .vote-bar {
            background: #b7c0c8;
            /* White for voted and highest */
            opacity: 1;
            color: #fff;
        }

        /* When the option is highest but not voted */
        .option.highest:not(.voted) .vote-bar {
            background: #b7c0c8;
            /* Default for highest if not voted, adjust if needed */
            opacity: 1;
            color: #fff;
        }

        /* Dark mode adjustments */
        .dark .vote-bar {
            background: #555;
            /* Default for unvoted in dark mode */
        }

        .dark .option.voted .vote-bar {
            background: #000;
            /* Black for voted in dark mode */
        }

        .dark .option.voted.highest .vote-bar {
            background: #fff;
            /* White for voted and highest in dark mode */
        }

        .dark .option.highest:not(.voted) .vote-bar {
            background: #000;
            /* Adjust for dark mode if needed */
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        .dark .ripple {
            background: rgba(0, 0, 0, 0.4);
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        .option.voted {
            /* Black background for the selected option */
            /* White text for contrast */
            /* Slight scale up for emphasis */
            opacity: 1;
            background: #f5f5f5;
            color: #fff;
        }

        .option:not(.voted) {
            background: #f5f5f5;
            /* Grey for unselected options after voting */
            transform: scale(1);
            /* Reset scale */
        }

        .option:hover:not(.voted) {
            background: #e8e8e8;
            /* Slightly darker grey on hover before voting */
            transform: scale(1.02);
            /* Subtle scale on hover */
        }

        .option:active:not(.voted) {
            transform: scale(0.98);
            /* Slight shrink on click */
        }

        /* Dark mode adjustments */
        .dark .option {
            background: #333;
            /* Default in dark mode before voting */
        }

        .dark .option.voted {
            background: #fff;
            /* White in dark mode for selected option */
            color: #000;
            /* Black text for contrast */
        }

        .dark .option:not(.voted) {
            background: #555;
            /* Darker grey for unselected in dark mode */
        }

        .dark .option:hover:not(.voted) {
            background: #444;
            /* Hover effect in dark mode */
        }

        .option.voted {
            background: #f2f2f2;
            transform: scale(1.02);
            color: #fff;
        }

        .option.voted:not(.highest) {
            color: #000;
        }

        .option.voted:not(.highest) .tick-icon {
            color: #000;
        }

        .option.highest {
            background: #f2f2f2;
        }

        .option.highest:not(.voted) {
            color: #fff;
        }

        .option:not(.voted).vote-bar {
            opacity: 0.5;
        }

        .option:hover:not(.voted) {
            background: #e8e8e8;
            transform: scale(1.02);
        }

        .option:active:not(.voted) {
            transform: scale(0.98);
        }


        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            animation: modalPop 0.3s ease forwards;
        }

        input,
        button {
            width: 100%;
            margin: 8px 0;
            padding: 12px;
            border: none;
            background: #f5f5f5;
            color: #000;
            border-radius: 10px;
            font-size: 1em;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        input:focus {
            background: #e8e8e8;
            outline: none;
        }

        button {
            background: #000;
            color: #fff;
            cursor: pointer;
        }

        button:hover {

            transform: scale(1);
        }

        .secondary-btn {
            background: #f5f5f5;
            color: #000;
        }

        .secondary-btn:hover {
            background: #e5e5e5;
        }

        .loader {
            border: 3px solid #e8e8e8;
            border-top: 3px solid #000;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        .tag {
            background: #e8e8e8;
            padding: 4px 8px;
            border-radius: 8px;
            color: #6e6e73;
            font-size: 0.85em;
            margin-left: 8px;
        }

        .timer,
        .poll-stats {
            color: #777;
            margin-top: 8px;
            font-size: 0.85em;
        }

        .no-polls {
            text-align: center;
            color: #6e6e73;
            font-weight: 500;
            font-size: 1.1em;
            margin-top: 20px;
        }

        .menu-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            width: 30px;
            height: 30px;
            transition: transform 0.2s ease;
        }

        .menu-btn:hover {
            transform: scale(1.1);
        }

        .menu-btn svg {
            width: 20px;
            height: 20px;
            color: #000;
        }

        .context-menu {
            display: none;
            position: absolute;
            top: -30px;
            right: 12px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 160px;
            transform: scale(0.95);
            opacity: 0;
            animation: menuPop 0.2s ease forwards;
        }

        .context-menu button {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: none;
            color: #000;
            font-size: 0.9em;
            border-radius: 0;
            transition: background 0.2s ease;
        }

        .context-menu button:hover {
            background: #f5f5f5;
            scale: 1;
        }

        .context-menu button svg {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        .context-menu button {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: none;
            color: #000;
            font-size: 0.9em;
            border-radius: 0;
            transition: background 0.2s ease;
            width: 100%;
        }

        .context-menu button:hover {
            background: #f5f5f5;
        }

        .context-menu button svg {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        .load-more-btn {
            position: fixed;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: #000;
            color: #fff;
            border: none;
            width: fit-content;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            transition: bottom 0.3s ease, transform 0.2s ease;
            z-index: 50;
        }

        .load-more-btn.visible {
            bottom: 80px;
        }

        /* Above bottom nav */
        .load-more-btn:hover {
            transform: translateX(-50%) scale(1.05);
        }

        /* Mobile Styles */
        @media (max-width: 767px) {
            body {
                padding: 16px;
                padding-bottom: 80px;
            }

            .container {
                padding-top: 120px;
            }

            .tab-bar {
                top: 0;
                padding: 8px 16px;
            }

            .poll {
                padding: 16px;
                margin-bottom: 65px;
            }

            .poll-title {
                font-size: 1.3em;
            }

            .user-circle {
                width: 24px;
                height: 24px;
                font-size: 0.9em;
                margin-right: 6px;
            }
            
            .context-menu {
                top: -45px;
            }

            .user-container {
                font-size: 0.85em;
            }

            .option {
                padding: 10px 12px;
                font-size: 0.9em;
            }

            .modal-content {
                padding: 16px;
                width: 90%;
                max-width: 340px;
            }

            .bottom-nav {
                padding: 8px 0;
            }

            .action-btn {
                padding: 8px;
            }

            .action-btn svg {
                width: 20px;
                height: 20px;
            }

            .load-more-btn.visible {
                bottom: 70px;
            }
        }

        /* Desktop Styles */
        @media (min-width: 768px) {
            body {
                padding: 32px;
                padding-bottom: 80px;
            }

            .container {
                max-width: 800px;
                padding-top: 120px;
            }

            .tab-bar {
                top: 0;
            }

            .poll {
                padding: 20px;

            }

            .poll-title {
                font-size: 1.6em;
            }

            .user-circle {
                width: 32px;
                height: 32px;
                font-size: 1.1em;
            }

            .user-container {
                font-size: 0.95em;
            }

            .option {
                padding: 12px 16px;
                font-size: 1em;
            }

            .modal-content {
                padding: 24px;
                max-width: 480px;
            }
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes modalPop {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes menuPop {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Dark Mode */
        .dark body {
            background: #000;
            color: #fff;
        }

        .dark .bottom-nav {
            background: rgba(0, 0, 0, 0.95);
            box-shadow: 0 -2px 8px rgba(255, 255, 255, 0.05);
        }

        .dark .action-btn {
            background: none;
        }

        .dark .action-btn:hover {
            opacity: 0.8;
        }

        .dark .tab-bar {
            background: rgba(0, 0, 0, 0.95);
            box-shadow: 0 2px 6px rgba(255, 255, 255, 0.05);
        }

        .dark .poll {
            background: #1a1a1a;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
        }

        .dark .option {
            background: #333;
        }

        .dark .option.voted {
            background: #444;
        }

        .dark .option.highest {
            background: #555;
        }

        .dark .option:hover:not(.voted) {
            background: #444;
        }

        .dark .modal-content {
            background: #1a1a1a;
        }

        .dark input,
        .dark button {
            background: #333;
            color: #fff;
        }

        .dark input:focus {
            background: #444;
        }

        .dark button {
            background: #fff;
            color: #000;
        }

        .dark button:hover {
            background: #e5e5e5;
        }

        .dark .secondary-btn {
            background: #333;
            color: #fff;
        }

        .dark .secondary-btn:hover {
            background: #444;
        }

        .dark .context-menu {
            background: #1a1a1a;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
        }

        .dark .context-menu button {
            color: #fff;
        }

        .dark .context-menu button:hover {
            background: #333;
        }

        .dark .load-more-btn {
            background: #fff;
            color: #000;
        }

        .dark .load-more-btn:hover {
            background: #e5e5e5;
        }

        .search-bar {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 15;
        }

        .search-bar input {
            width: 200px;
        }

        .category-filter,
        .sort-options {
            position: fixed;
            top: 100px;
            z-index: 15;
        }

        .category-filter {
            left: 20px;
        }

        .sort-options {
            right: 20px;
        }

        .category-filter select,
        .sort-options select {
            padding: 8px;
            border-radius: 8px;
            background: #f5f5f5;
            border: none;
        }

        .comments-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .comment {
            padding: 8px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-likes {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 8px;
            border-bottom: 1px solid #e5e5e5;
        }

        .drafts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .draft-item {
            padding: 8px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
        }

        #pollChart {
            margin-top: 20px;
            max-height: 200px;
        }

        .following-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .follow-item {
            padding: 8px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
        }

        /* Theme Variations */
        .blue body {
            background: #e6f0ff;
        }

        .blue .poll {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.1);
        }

        .blue button {
            background: #0066cc;
        }

        .green body {
            background: #e6ffe6;
        }

        .green .poll {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0, 153, 0, 0.1);
        }

        .green button {
            background: #009900;
        }

        #searchPopup .modal-content {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        #searchResults .poll {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="tab-bar" id="tabBar"></div>
    <div class="container" id="activePollsContainer"></div>
    <div class="container" id="votedPollsContainer" style="display: none;"></div>
    <div class="container" id="myPollsContainer" style="display: none;"></div>
    <div class="modal" id="authModal">
        <div class="modal-content">
            <h2>Sign In or Up</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="App.loginOrSignup()">Submit</button>
            <button class="secondary-btn" onclick="App.closeModal()">Cancel</button>
        </div>
    </div>
    <div class="modal" id="createPollModal">
        <div class="modal-content">
            <h2>Create Poll</h2>
            <input type="text" id="pollQuestion" placeholder="Question">
            <input type="text" id="option1" placeholder="Option 1">
            <input type="text" id="option2" placeholder="Option 2">
            <input type="text" id="option3" placeholder="Option 3 (optional)">
            <input type="text" id="option4" placeholder="Option 4 (optional)">
            <input type="text" id="pollTags" placeholder="Tags (e.g., fun, school)">
            <input type="number" id="pollTimer" placeholder="Expiration (hours)">
            <button onclick="App.submitPoll()">Create</button>
            <button class="secondary-btn" onclick="App.closeModal()">Cancel</button>
        </div>
    </div>
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <h2>Profile</h2>
            <p id="userNameDisplay"></p>
            <input type="text" id="newUserName" placeholder="New Username">
            <button onclick="App.updateUserName()">Update</button>
            <button onclick="App.toggleDarkMode()">Dark Mode</button>
            <button onclick="App.exportData()">Export Data</button>
            <button class="secondary-btn" onclick="App.logout()">Logout</button>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <h2>Stats</h2>
            <p id="statsDisplay"></p>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <h2>Report Poll</h2>
            <input type="text" id="reportReason" placeholder="Reason for reporting">
            <button onclick="App.submitReport()">Submit</button>
            <button class="secondary-btn" onclick="App.closeModal()">Cancel</button>
        </div>
    </div>
    <div class="loader" id="loader"></div>
    <button class="load-more-btn" id="loadMoreBtn" onclick="App.loadMorePoll()">Load More</button>


    <div class="bottom-nav">
        <!-- Search Button (Magnifying Glass Icon) -->
        <button style="display: none;" class="action-btn" onclick="App.showSearchPopup()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
        </button>

        <!-- Profile Button (User Icon) -->
        <button class="action-btn" onclick="App.showProfile()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
            </svg>
        </button>

        <!-- Create Poll Button (Plus Icon) -->
        <button class="action-btn" onclick="App.showCreatePoll()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
        </button>

        <!-- Activity Feed Button (Bell Icon) -->
        <button class="action-btn" onclick="App.showActivityFeed()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
            </svg>
        </button>

        <!-- Save Draft Button (Arrow Up Tray Icon) -->
        <button class="action-btn" onclick="App.saveDraft()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 0 1 9 9v.375M10.125 2.25A3.375 3.375 0 0 1 13.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 0 1 3.375 3.375M9 15l2.25 2.25L15 12" />
            </svg>

        </button>
    </div>

    <!-- Search Bar
    <div class="search-bar" id="searchBar">
        <input type="text" id="searchInput" placeholder="Search polls...">
        <button onclick="App.searchPolls()">Search</button>
    </div>-->

    <!-- Category Filter
    <div class="category-filter" id="categoryFilter">
        <select id="categorySelect" onchange="App.filterByCategory(this.value)">
            <option value="all">All Categories</option>
            <option value="General">General</option>
            <option value="Fun">Fun</option>
            <option value="News">News</option>
            <option value="Tech">Tech</option>
        </select>
    </div>-->

    <!-- Sort Options
    <div class="sort-options" id="sortOptions">
        <select id="sortSelect" onchange="App.sortPolls(this.value)">
            <option value="newest">Newest</option>
            <option value="votes">Most Votes</option>
            <option value="expiring">Expiring Soon</option>
        </select>
    </div>-->

    <!-- Comments Modal -->
    <div class="modal" id="commentsModal">
        <div class="modal-content">
            <h2>Comments</h2>
            <div id="commentsList"></div>
            <input type="text" id="commentInput" placeholder="Add a comment...">
            <button onclick="App.addComment()">Post</button>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>

    <!-- Activity Feed Modal -->
    <div class="modal" id="activityModal">
        <div class="modal-content">
            <h2>Activity Feed</h2>
            <div id="activityFeed"></div>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>

    <!-- Drafts Modal -->
    <div class="modal" id="draftsModal">
        <div class="modal-content">
            <h2>Saved Drafts</h2>
            <div id="draftsList"></div>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal" id="analyticsModal">
        <div class="modal-content">
            <h2>Poll Analytics</h2>
            <div id="analyticsDisplay"></div>
            <canvas id="pollChart"></canvas>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>

    <!-- Follow Modal -->
    <div class="modal" id="followModal">
        <div class="modal-content">
            <h2>Follow Users</h2>
            <input type="text" id="followInput" placeholder="Enter username...">
            <button onclick="App.followUser()">Follow</button>
            <div id="followingList"></div>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>

    <!-- Theme Modal -->
    <div class="modal" id="themeModal">
        <div class="modal-content">
            <h2>Customize Theme</h2>
            <select id="themeSelect" onchange="App.applyTheme(this.value)">
                <option value="default">Default</option>
                <option value="dark">Dark</option>
                <option value="blue">Blue</option>
                <option value="green">Green</option>
            </select>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>

    <!-- Archive Modal -->
    <div class="modal" id="archiveModal">
        <div class="modal-content">
            <h2>Archived Polls</h2>
            <div id="archiveList"></div>
            <button class="secondary-btn" onclick="App.closeModal()">Close</button>
        </div>
    </div>

    <!-- Search Popup -->
    <div class="modal" id="searchPopup" style="background: rgba(0, 0, 0, 0.8);">
        <div class="modal-content" style="width: 90%; max-width: 800px; height: 90vh;">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="searchPopupInput" placeholder="Search polls..." style="flex: 1;">
                <button onclick="App.searchPollsFromPopup()">Search</button>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <select id="categoryPopupSelect" onchange="App.filterByCategoryFromPopup(this.value)">
                    <option value="all">All Categories</option>
                    <option value="General">General</option>
                    <option value="Fun">Fun</option>
                    <option value="News">News</option>
                    <option value="Tech">Tech</option>
                </select>
                <select id="sortPopupSelect" onchange="App.sortPollsFromPopup(this.value)">
                    <option value="newest">Newest</option>
                    <option value="votes">Most Votes</option>
                    <option value="expiring">Expiring Soon</option>
                </select>
            </div>
            <div id="searchResults" style="overflow-y: auto; max-height: calc(90vh - 150px);"></div>
            <button class="secondary-btn" onclick="App.closeModal()" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);">Close</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAGCBoD6Cn7lnTD8R-sQHBTE5IdFVq0hBA",
            authDomain: "nglhonestly.firebaseapp.com",
            databaseURL: "https://nglhonestly-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nglhonestly",
            storageBucket: "nglhonestly.firebasestorage.app",
            messagingSenderId: "1002591277776",
            appId: "1:1002591277776:web:9f71be9c14642a188744d5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Application State
        const state = {
            currentUser: null,
            activeTab: 'active',
            polls: {},
            votedPolls: JSON.parse(localStorage.getItem('votedPolls') || '[]'),
            createdPolls: JSON.parse(localStorage.getItem('createdPolls') || '[]'),
            bookmarks: JSON.parse(localStorage.getItem('bookmarks') || '[]'),
            voteStreak: parseInt(localStorage.getItem('voteStreak') || '0'),
            darkMode: localStorage.getItem('darkMode') === 'true',
            pinned: JSON.parse(localStorage.getItem('pinned') || '[]') // Add this line if not present
        };

        // UI Utilities
        const UI = {
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            padding: 8px 16px; background: ${type === 'error' ? '#ff3b30' : '#000'};
            color: #fff; border-radius: 10px; z-index: 1000; font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); opacity: 0; transition: opacity 0.3s ease;
        `;
                document.body.appendChild(toast);
                requestAnimationFrame(() => {
                    toast.style.opacity = '1';
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                });
            },

            toggleLoader(show) {
                document.getElementById('loader').style.display = show ? 'block' : 'none';
            },

            showModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            },

            hideModals() {
                document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
            },

            updateTabBar() {
                const tabBar = document.getElementById('tabBar');
                tabBar.innerHTML = state.currentUser ? `
            <button class="tab-btn ${state.activeTab === 'active' ? 'active' : ''}" onclick="App.switchTab('active')">Active</button>
            <button class="tab-btn ${state.activeTab === 'voted' ? 'active' : ''}" onclick="App.switchTab('voted')">Voted</button>
            <button class="tab-btn ${state.activeTab === 'my' ? 'active' : ''}" onclick="App.switchTab('my')">My Polls</button>
        ` : `
            <button class="tab-btn ${state.activeTab === 'active' ? 'active' : ''}" onclick="App.switchTab('active')">Active</button>
            <button class="tab-btn ${state.activeTab === 'voted' ? 'active' : ''}" onclick="App.switchTab('voted')">Voted</button>
        `;
            },

            updateProfileDisplay() {
                if (!state.currentUser) return;
                db.collection('users').doc(state.currentUser.uid).get()
                    .then(doc => {
                        const username = doc.exists ? doc.data().username : 'Not set';
                        document.getElementById('userNameDisplay').textContent = username;
                    })
                    .catch(err => UI.showToast(`Profile error: ${err.message}`, 'error'));
            }
        };

        // Application Logic
        const App = {
            async init() {
                firebase.auth().onAuthStateChanged(async user => {
                    state.currentUser = user;
                    UI.updateTabBar();
                    if (user) {
                        await this.syncVotedPolls();
                        UI.updateProfileDisplay();
                        UI.showToast('Signed in!');
                    } else {
                        state.votedPolls = JSON.parse(localStorage.getItem('votedPolls') || '[]');
                    }
                    this.loadPolls(true);
                    if (state.darkMode) document.body.classList.add('dark');
                });
            },

            async syncVotedPolls() {
                if (!state.currentUser) return;
                const userRef = db.collection('users').doc(state.currentUser.uid);
                const votedRef = userRef.collection('voted');

                const localVoted = JSON.parse(localStorage.getItem('votedPolls') || '[]');
                for (const pollId of localVoted) {
                    await votedRef.doc(pollId).set({
                        votedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, {
                        merge: true
                    });
                }

                const snapshot = await votedRef.get();
                state.votedPolls = snapshot.docs.map(doc => doc.id);
                localStorage.setItem('votedPolls', JSON.stringify(state.votedPolls));
            },

            switchTab(tab) {
                state.activeTab = tab;
                const containers = {
                    active: 'activePollsContainer',
                    voted: 'votedPollsContainer',
                    my: 'myPollsContainer'
                };
                Object.values(containers).forEach(id => {
                    document.getElementById(id).style.display = id === containers[tab] ? 'block' : 'none';
                });
                UI.updateTabBar();
                if (tab === 'active') this.loadPolls();
                else if (tab === 'voted') this.loadVotedPolls();
                else this.loadMyPolls();
            },

            async loadPolls(isInitial = false) {
                const activeContainer = document.getElementById('activePollsContainer');
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                UI.toggleLoader(true);

                try {
                    const snapshot = await rtdb.ref('polls').once('value');
                    const polls = snapshot.val() || {};
                    state.polls = polls;

                    const pollIds = Object.keys(polls).filter(id => !polls[id].expires || polls[id].expires > Date.now());
                    if (!pollIds.length) {
                        activeContainer.innerHTML = '<div class="no-polls">No active polls.</div>';
                        UI.toggleLoader(false);
                        return;
                    }

                    const availableIds = this.filterAvailablePolls(pollIds);
                    if (!availableIds.length) {
                        activeContainer.innerHTML = '<div class="no-polls">All voted! Check your polls.</div>';
                        UI.toggleLoader(false);
                        return;
                    }

                    // Check if there's already an unvoted poll in the container
                    const existingPolls = Array.from(activeContainer.children)
                        .filter(child => child.className === 'poll')
                        .map(poll => {
                            const title = poll.querySelector('.poll-title').textContent;
                            return Object.entries(state.polls).find(([id, p]) => p.question === title)?.[0];
                        })
                        .filter(id => id && !state.votedPolls.includes(id));

                    if (isInitial || existingPolls.length === 0) {
                        // Only clear and load a new poll if it's initial load or no unvoted polls exist
                        const randomId = availableIds[Math.floor(Math.random() * availableIds.length)];
                        if (isInitial) activeContainer.innerHTML = '';
                        this.renderPoll(polls[randomId], randomId, activeContainer);
                    }

                    // Update load more button visibility
                    const currentPollIds = Array.from(activeContainer.children)
                        .filter(child => child.className === 'poll')
                        .map(poll => {
                            const title = poll.querySelector('.poll-title').textContent;
                            return Object.entries(state.polls).find(([id, p]) => p.question === title)?.[0];
                        });
                    const allVoted = currentPollIds.every(id => state.votedPolls.includes(id));
                    loadMoreBtn.classList.toggle('visible', allVoted && availableIds.length > 0);

                    const latestPoll = activeContainer.lastElementChild;
                    if (latestPoll && isInitial) {
                        const screenHeight = window.innerHeight;
                        const pollHeight = latestPoll.offsetHeight;
                        const marginBottom = (screenHeight - pollHeight) / 2;
                        activeContainer.style.marginBottom = `${marginBottom}px`;
                        setTimeout(() => activeContainer.style.marginBottom = '20px', 3100);
                    }

                    if (isInitial) {
                        setTimeout(() => window.scrollTo({
                            top: document.body.scrollHeight,
                            behavior: 'smooth'
                        }), 100);
                    }
                } catch (err) {
                    activeContainer.innerHTML = `<div class="no-polls">Error: ${err.message}</div>`;
                    UI.showToast(`Error: ${err.message}`, 'error');
                } finally {
                    UI.toggleLoader(false);
                }
            },

            loadMorePoll() {
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                loadMoreBtn.classList.remove('visible');
                setTimeout(() => this.loadPolls(false), 300);
            },

            async loadVotedPolls() {
                const votedContainer = document.getElementById('votedPollsContainer');
                UI.toggleLoader(true);

                try {
                    const snapshot = await rtdb.ref('polls').once('value');
                    const polls = snapshot.val() || {};
                    if (!state.votedPolls.length) {
                        votedContainer.innerHTML = '<div class="no-polls">No voted polls.</div>';
                        return;
                    }

                    votedContainer.innerHTML = '';
                    state.votedPolls.forEach(pollId => {
                        if (polls[pollId] && (!polls[pollId].expires || polls[pollId].expires > Date.now())) {
                            this.renderPoll(polls[pollId], pollId, votedContainer, true);
                        }
                    });
                } catch (err) {
                    votedContainer.innerHTML = `<div class="no-polls">Error: ${err.message}</div>`;
                    UI.showToast(`Error: ${err.message}`, 'error');
                } finally {
                    UI.toggleLoader(false);
                }
            },

            async loadMyPolls() {
                if (!state.currentUser) return;
                const myContainer = document.getElementById('myPollsContainer');
                UI.toggleLoader(true);

                try {
                    const snapshot = await rtdb.ref('polls').once('value');
                    const polls = snapshot.val() || {};
                    const myPollIds = Object.keys(polls).filter(id => polls[id].creatorId === state.currentUser.uid && (!polls[id].expires || polls[id].expires > Date.now()));

                    if (!myPollIds.length) {
                        myContainer.innerHTML = '<div class="no-polls">No active polls by you.</div>';
                        return;
                    }

                    myContainer.innerHTML = '';
                    myPollIds.forEach(pollId => this.renderPoll(polls[pollId], pollId, myContainer, false, true));
                } catch (err) {
                    myContainer.innerHTML = `<div class="no-polls">Error: ${err.message}</div>`;
                    UI.showToast(`Error: ${err.message}`, 'error');
                } finally {
                    UI.toggleLoader(false);
                }
            },

            filterAvailablePolls(pollIds) {
                let availableIds = pollIds.filter(id => !state.votedPolls.includes(id));
                if (state.currentUser) {
                    availableIds = availableIds.filter(id => state.polls[id].creatorId !== state.currentUser.uid);
                    if (!availableIds.length) {
                        availableIds = pollIds.filter(id => !state.votedPolls.includes(id));
                    }
                }
                return availableIds;
            },

            renderPoll(poll, pollId, container, isVoted = false, isMine = false, existingPollDiv = null) {
                const hasVoted = state.votedPolls.includes(pollId);
                const userVote = localStorage.getItem(`vote_${pollId}`);
                const pollDiv = existingPollDiv || document.createElement('div');
                if (!existingPollDiv) pollDiv.className = 'poll';

                const userName = poll.userName || 'Unknown';
                pollDiv.innerHTML = `
        <div class="poll-title">${poll.question || 'Untitled'}</div>
        <div class="user-container">
            <div class="user-circle">${userName.charAt(0).toUpperCase()}</div>
            <div>${userName}${poll.tags ? `<span class="tag">${poll.tags}</span>` : ''}</div>
        </div>
        ${poll.expires ? `<div class="timer">Expires in ${Math.ceil((poll.expires - Date.now()) / 3600000)}h</div>` : ''}
    `;

                const optionsDiv = document.createElement('div');
                const totalVotes = Object.values(poll.options || {}).reduce((sum, votes) => sum + votes, 0);
                const highestVote = Math.max(...Object.values(poll.options || {}));

                Object.keys(poll.options || {}).forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = `option ${userVote === option && hasVoted ? 'voted' : ''}`;
                    const votes = poll.options[option] || 0;
                    const percentage = totalVotes ? (votes / totalVotes) * 100 : 0;

                    // Heroicons checkmark SVG
                    const tickSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="tick-icon size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
        `;

                    // Show vote bar and percentage only after voting
                    optionDiv.innerHTML = `
            ${hasVoted ? `<div class="vote-bar ${votes === highestVote ? 'highest' : ''}" style="width: ${percentage}%;"></div>` : ''}
            <div class="option-text">
                ${option}${userVote === option && hasVoted ? tickSvg : ''}
            </div>
            ${hasVoted ? `<div class="option-percentage">${percentage.toFixed(1)}%</div>` : ''}
        `;
                    if (!hasVoted) optionDiv.onclick = () => this.vote(pollId, option, optionsDiv, pollDiv);
                    optionsDiv.appendChild(optionDiv);
                });

                // Real-time listener for vote updates (only updates if user has voted)
                rtdb.ref(`polls/${pollId}/options`).on('value', snapshot => {
                    if (snapshot.val() && hasVoted) { // Only update UI if user has voted
                        this.updateVotes(snapshot.val(), optionsDiv, hasVoted, userVote);
                    }
                });

                const statsDiv = document.createElement('div');
                statsDiv.className = 'poll-stats';
                const formattedDate = new Date(poll.createdAt).toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                statsDiv.textContent = `${totalVotes} votes • ${formattedDate}`;
                pollDiv.appendChild(statsDiv);

                const menuBtn = document.createElement('button');
                menuBtn.className = 'menu-btn';
                menuBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
        </svg>
    `;

                const contextMenu = document.createElement('div');
                contextMenu.className = 'context-menu';
                contextMenu.innerHTML = `
        <button onclick="App.sharePoll('${pollId}', '${poll.question}')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z" />
            </svg>
            Copy link
        </button>
        ${hasVoted ? `
            <button onclick="App.unvote('${pollId}', this.closest('.poll'))">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                Unvote
            </button>
        ` : ''}
        ${isMine ? `
            <button onclick="App.deletePoll('${pollId}', this.closest('.poll'))">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>
                Delete
            </button>
        ` : ''}
        <button onclick="App.bookmarkPoll('${pollId}')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
            </svg>
            Bookmark
        </button>
        <button onclick="App.showReportModal('${pollId}')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
            Report
        </button>
        <button class="poll-action-btn" onclick="App.showComments('${pollId}')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97c-.814-.14-1.524-.744-1.768-1.52C3.503 18.638 3 17.548 3 16.5V12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
            </svg>
            Comments
        </button>
        ${isMine ? `
            <button class="poll-action-btn" onclick="App.editPoll('${pollId}')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.25.8.8-2.25a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                </svg>
                Edit
            </button>
        ` : ''}
        ${isMine ? `
            <button class="poll-action-btn" onclick="App.showAnalytics('${pollId}')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                </svg>
                Analytics
            </button>
        ` : ''}
        <button class="poll-action-btn" onclick="App.pinPoll('${pollId}')" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" />
            </svg>
            Pin
        </button>
    `;

                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isVisible = contextMenu.style.display === 'block';
                    document.querySelectorAll('.context-menu').forEach(menu => menu.style.display = 'none');
                    contextMenu.style.display = isVisible ? 'none' : 'block';
                });

                document.addEventListener('click', (e) => {
                    if (!pollDiv.contains(e.target)) {
                        contextMenu.style.display = 'none';
                    }
                });

                pollDiv.appendChild(menuBtn);
                pollDiv.appendChild(contextMenu);
                pollDiv.appendChild(optionsDiv);

                if (!existingPollDiv) container.appendChild(pollDiv);
                if (poll.private) pollDiv.classList.add('private');
                this.updateCountdowns();
            },

            updateVotes(options, optionsDiv, hasVoted, userVote) {
                const totalVotes = Object.values(options).reduce((sum, votes) => sum + votes, 0);
                const highestVote = Math.max(...Object.values(options));
                Array.from(optionsDiv.children).forEach(optionDiv => {
                    if (optionDiv.classList.contains('option')) {
                        const optionTextElement = optionDiv.querySelector('.option-text');
                        const optionText = optionTextElement.textContent.trim().replace(/<svg.*<\/svg>/, ''); // Remove SVG from text
                        const votes = options[optionText] || 0;
                        const percentage = totalVotes ? (votes / totalVotes) * 100 : 0;

                        const voteBar = optionDiv.querySelector('.vote-bar');
                        const percentageDiv = optionDiv.querySelector('.option-percentage');

                        voteBar.style.width = `${percentage}%`; // Always set width based on current votes
                        percentageDiv.textContent = `${percentage.toFixed(1)}%`;

                        if (hasVoted) {
                            optionDiv.classList.toggle('highest', votes === highestVote);
                            voteBar.classList.toggle('highest', votes === highestVote);
                            optionDiv.onclick = null; // Disable clicking after voting
                        }

                        // Ensure voted class persists if this is the user's vote
                        if (userVote === optionText && hasVoted) {
                            optionDiv.classList.add('voted');
                        } else {
                            optionDiv.classList.remove('voted');
                        }
                    }
                });
            },

            async vote(pollId, selectedOption, optionsDiv, pollDiv) {
                try {
                    // Update vote count in Realtime Database
                    await rtdb.ref(`polls/${pollId}/options/${selectedOption}`).transaction(votes => (votes || 0) + 1);

                    // Update user vote state
                    if (state.currentUser) {
                        await db.collection('users').doc(state.currentUser.uid)
                            .collection('voted').doc(pollId).set({
                                votedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                selectedOption: selectedOption
                            });
                        if (!state.votedPolls.includes(pollId)) {
                            state.votedPolls.push(pollId); // Avoid duplicates
                        }
                    } else {
                        if (!state.votedPolls.includes(pollId)) {
                            state.votedPolls.push(pollId); // Avoid duplicates
                            localStorage.setItem('votedPolls', JSON.stringify(state.votedPolls));
                        }
                    }

                    localStorage.setItem(`vote_${pollId}`, selectedOption);

                    // Update vote streak
                    state.voteStreak++;
                    localStorage.setItem('voteStreak', state.voteStreak);
                    if (state.voteStreak % 5 === 0) UI.showToast(`Streak: ${state.voteStreak}!`);

                    // Fetch updated poll data
                    const snapshot = await rtdb.ref(`polls/${pollId}`).once('value');
                    const updatedPoll = snapshot.val();
                    if (!updatedPoll) throw new Error('Poll data not found after voting');

                    // Animate the selected option
                    const selectedOptionDiv = Array.from(optionsDiv.children).find(div =>
                        div.querySelector('.option-text').textContent.trim().replace(/<svg.*<\/svg>/, '') === selectedOption
                    );
                    if (selectedOptionDiv) {
                        selectedOptionDiv.style.transition = 'background 0.3s ease, transform 0.3s ease, opacity 0.3s ease';
                        selectedOptionDiv.style.background = state.darkMode ? '#fff' : '#f2f2f2'; // Match CSS .voted background
                        selectedOptionDiv.style.color = '#000'; // Consistent with CSS
                        selectedOptionDiv.style.transform = 'scale(1.05)';
                        selectedOptionDiv.style.opacity = '0.9';

                        setTimeout(() => {
                            selectedOptionDiv.style.transform = 'scale(1.02)';
                            selectedOptionDiv.style.opacity = '1';
                            // Ensure class is applied after animation for persistence
                            selectedOptionDiv.classList.add('voted');
                        }, 300);
                    }

                    // Animate poll div out and re-render
                    pollDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    pollDiv.style.opacity = '0';
                    pollDiv.style.transform = 'translateY(20px)';

                    setTimeout(() => {
                        pollDiv.innerHTML = '';
                        this.renderPoll(updatedPoll, pollId, pollDiv.parentElement, true, state.currentUser && updatedPoll.creatorId === state.currentUser.uid, pollDiv);
                        pollDiv.style.opacity = '1';
                        pollDiv.style.transform = 'translateY(0)';
                    }, 300);

                    UI.showToast('Vote recorded! Next poll...');
                    setTimeout(() => this.loadPolls(), 3000);
                } catch (err) {
                    console.error('Voting error:', err); // Log for debugging
                    UI.showToast(`Error: ${err.message}`, 'error');

                    // Rollback local state if not signed in and error occurs
                    if (!state.currentUser) {
                        state.votedPolls = state.votedPolls.filter(id => id !== pollId);
                        localStorage.setItem('votedPolls', JSON.stringify(state.votedPolls));
                        localStorage.removeItem(`vote_${pollId}`);
                    }
                }
            },

            async unvote(pollId, pollDiv) {
                const userVote = localStorage.getItem(`vote_${pollId}`);
                if (!userVote) {
                    UI.showToast('No vote to remove.', 'error');
                    return;
                }

                try {
                    await rtdb.ref(`polls/${pollId}/options/${userVote}`).transaction(votes => (votes || 1) - 1 >= 0 ? (votes || 1) - 1 : 0);

                    if (state.currentUser) {
                        await db.collection('users').doc(state.currentUser.uid)
                            .collection('voted').doc(pollId).delete();
                        state.votedPolls = state.votedPolls.filter(id => id !== pollId);
                    } else {
                        state.votedPolls = state.votedPolls.filter(id => id !== pollId);
                        localStorage.setItem('votedPolls', JSON.stringify(state.votedPolls));
                    }

                    localStorage.removeItem(`vote_${pollId}`);
                    UI.showToast('Vote removed!');

                    const snapshot = await rtdb.ref(`polls/${pollId}`).once('value');
                    const updatedPoll = snapshot.val();
                    pollDiv.innerHTML = '';
                    this.renderPoll(updatedPoll, pollId, pollDiv.parentElement, false, state.currentUser && updatedPoll.creatorId === state.currentUser.uid);
                    this.loadVotedPolls();
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            async deletePoll(pollId, pollDiv) {
                if (!confirm('Delete this poll?')) return;
                try {
                    await rtdb.ref(`polls/${pollId}`).remove();
                    pollDiv.style.transition = 'opacity 0.3s ease';
                    pollDiv.style.opacity = '0';
                    setTimeout(() => pollDiv.remove(), 300);
                    UI.showToast('Poll deleted!');
                    this.loadPolls();
                    this.loadVotedPolls();
                    this.loadMyPolls();
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            sharePoll(pollId, question) {
                const url = `zandenkoh.github.io/pollen/?poll=${pollId}`;
                navigator.clipboard.writeText(`${question} - ${url}`)
                    .then(() => UI.showToast('Copied!'))
                    .catch(() => UI.showToast('Copy failed', 'error'));
            },

            bookmarkPoll(pollId) {
                if (!state.bookmarks.includes(pollId)) {
                    state.bookmarks.push(pollId);
                    localStorage.setItem('bookmarks', JSON.stringify(state.bookmarks));
                    UI.showToast('Bookmarked!');
                } else {
                    UI.showToast('Already bookmarked!');
                }
            },

            showReportModal(pollId) {
                UI.showModal('reportModal');
                document.getElementById('reportReason').dataset.pollId = pollId;
            },

            async submitReport() {
                const reason = document.getElementById('reportReason').value.trim();
                const pollId = document.getElementById('reportReason').dataset.pollId;
                if (!reason) {
                    UI.showToast('Reason required', 'error');
                    return;
                }
                try {
                    await db.collection('reports').add({
                        pollId,
                        userId: state.currentUser?.uid || 'anonymous',
                        reason,
                        timestamp: Date.now()
                    });
                    UI.showToast('Reported!');
                    UI.hideModals();
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            showCreatePoll() {
                state.currentUser ? UI.showModal('createPollModal') : UI.showModal('authModal');
            },

            showProfile() {
                state.currentUser ? UI.showModal('profileModal') : UI.showModal('authModal');
            },

            showStats() {
                if (!state.currentUser) {
                    UI.showToast('Sign in first.', 'error');
                    return;
                }
                UI.showModal('statsModal');
                document.getElementById('statsDisplay').innerHTML = `
            Voted: ${state.votedPolls.length}<br>
            Streak: ${state.voteStreak}<br>
            Created: ${state.createdPolls.length}<br>
            Bookmarks: ${state.bookmarks.length}<br>
            Fact: ${this.getRandomFact()}
        `;
            },

            getRandomFact() {
                const facts = ['Polls began in 1824.', 'Fastest poll: 3s.', '80% enjoy polls!', '"Poll" from "head".'];
                return facts[Math.floor(Math.random() * facts.length)];
            },

            closeModal() {
                UI.hideModals();
            },

            async loginOrSignup() {
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value.trim();
                if (!email || !password) {
                    UI.showToast('Email and password required.', 'error');
                    return;
                }

                try {
                    let userCredential;
                    try {
                        userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                    } catch {
                        userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                        const name = prompt('Pick a username:')?.trim();
                        if (!name) throw new Error('Username required');
                        await db.collection('users').doc(userCredential.user.uid).set({
                            uid: userCredential.user.uid,
                            username: name,
                            email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    UI.hideModals();
                    this.loadPolls(true);
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            async submitPoll() {
                if (!state.currentUser) {
                    UI.showToast('Sign in first.', 'error');
                    return;
                }

                const question = document.getElementById('pollQuestion').value.trim();
                const options = [
                    document.getElementById('option1').value.trim(),
                    document.getElementById('option2').value.trim(),
                    document.getElementById('option3').value.trim(),
                    document.getElementById('option4').value.trim()
                ].filter(opt => opt);
                const tags = document.getElementById('pollTags').value.trim();
                const timer = document.getElementById('pollTimer').value.trim();

                if (!question || options.length < 2) {
                    UI.showToast('Question + 2 options required.', 'error');
                    return;
                }

                try {
                    const doc = await db.collection('users').doc(state.currentUser.uid).get();
                    if (!doc.exists) throw new Error('User not found');
                    const userName = doc.data().username || 'Unknown';
                    const poll = {
                        question,
                        userName,
                        options: options.reduce((acc, opt) => ({
                            ...acc,
                            [opt]: 0
                        }), {}),
                        tags: tags || null,
                        expires: timer ? Date.now() + (parseInt(timer) * 3600000) : null,
                        createdAt: Date.now(),
                        creatorId: state.currentUser.uid,
                        category: tags ? tags.split(',')[0].trim() : 'General'
                    };
                    const ref = await rtdb.ref('polls').push(poll);
                    state.createdPolls.push(ref.key);
                    localStorage.setItem('createdPolls', JSON.stringify(state.createdPolls));
                    UI.showToast('Poll created!');
                    UI.hideModals();
                    this.loadPolls();
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            async updateUserName() {
                const newName = document.getElementById('newUserName').value.trim();
                if (!newName) {
                    UI.showToast('Enter a username.', 'error');
                    return;
                }
                try {
                    await db.collection('users').doc(state.currentUser.uid).update({
                        username: newName
                    });
                    UI.updateProfileDisplay();
                    UI.showToast('Updated!');
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            async logout() {
                try {
                    await firebase.auth().signOut();
                    state.voteStreak = 0;
                    localStorage.setItem('voteStreak', '0');
                    UI.showToast('Signed out!');
                    UI.hideModals();
                    this.loadPolls(true);
                } catch (err) {
                    UI.showToast(`Error: ${err.message}`, 'error');
                }
            },

            toggleDarkMode() {
                state.darkMode = !state.darkMode;
                document.body.classList.toggle('dark', state.darkMode);
                localStorage.setItem('darkMode', state.darkMode);
                UI.showToast('Mode toggled!');
            },

            exportData() {
                const data = {
                    votedPolls: state.votedPolls,
                    createdPolls: state.createdPolls,
                    bookmarks: state.bookmarks,
                    streak: state.voteStreak
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pollen_data.json';
                a.click();
                URL.revokeObjectURL(url);
                UI.showToast('Data exported!');
            }
        };

        App.searchPolls = function() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const filteredPolls = Object.entries(state.polls).filter(([_, poll]) =>
                poll.question.toLowerCase().includes(query) || (poll.tags && poll.tags.toLowerCase().includes(query)));
            this.renderFilteredPolls(filteredPolls, 'activePollsContainer');
        };

        App.filterByCategory = function(category) {
            const filteredPolls = category === 'all' ? Object.entries(state.polls) :
                Object.entries(state.polls).filter(([_, poll]) => poll.category === category);
            this.renderFilteredPolls(filteredPolls, 'activePollsContainer');
        };

        App.sortPolls = function(criteria) {
            let sortedPolls = Object.entries(state.polls);
            if (criteria === 'votes') {
                sortedPolls.sort((a, b) => Object.values(b[1].options).reduce((s, v) => s + v, 0) - Object.values(a[1].options).reduce((s, v) => s + v, 0));
            } else if (criteria === 'expiring') {
                sortedPolls.sort((a, b) => (a[1].expires || Infinity) - (b[1].expires || Infinity));
            } else {
                sortedPolls.sort((a, b) => b[1].createdAt - a[1].createdAt);
            }
            this.renderFilteredPolls(sortedPolls, 'activePollsContainer');
        };

        App.renderFilteredPolls = function(polls, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            polls.forEach(([id, poll]) => this.renderPoll(poll, id, container));
        };

        App.showComments = function(pollId) {
            UI.showModal('commentsModal');
            document.getElementById('commentsList').dataset.pollId = pollId;
            this.loadComments(pollId);
        };

        App.loadComments = async function(pollId) {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';
            const snapshot = await rtdb.ref(`comments/${pollId}`).once('value');
            const comments = snapshot.val() || {};
            Object.entries(comments).forEach(([id, comment]) => {
                const div = document.createElement('div');
                div.className = 'comment';
                div.innerHTML = `
            <span>${comment.text} - ${comment.userName}</span>
            <div class="comment-likes">
                <span>${comment.likes || 0}</span>
                <button onclick="App.likeComment('${pollId}', '${id}')">👍</button>
            </div>
        `;
                commentsList.appendChild(div);
            });
        };

        App.addComment = async function() {
            if (!state.currentUser) return UI.showToast('Sign in to comment', 'error');
            const pollId = document.getElementById('commentsList').dataset.pollId;
            const text = document.getElementById('commentInput').value.trim();
            if (!text) return UI.showToast('Comment required', 'error');
            const userDoc = await db.collection('users').doc(state.currentUser.uid).get();
            await rtdb.ref(`comments/${pollId}`).push({
                text,
                userName: userDoc.data().username,
                userId: state.currentUser.uid,
                timestamp: Date.now()
            });
            document.getElementById('commentInput').value = '';
            this.loadComments(pollId);
        };

        App.likeComment = async function(pollId, commentId) {
            if (!state.currentUser) return UI.showToast('Sign in to like', 'error');
            await rtdb.ref(`comments/${pollId}/${commentId}/likes`).transaction(likes => (likes || 0) + 1);
            this.loadComments(pollId);
        };

        App.showActivityFeed = async function() {
            if (!state.currentUser) return UI.showToast('Sign in to see activity', 'error');
            UI.showModal('activityModal');
            const feed = document.getElementById('activityFeed');
            feed.innerHTML = '';
            const following = (await db.collection('users').doc(state.currentUser.uid).get()).data().following || [];
            const snapshot = await rtdb.ref('polls').once('value');
            const polls = snapshot.val() || {};
            Object.entries(polls)
                .filter(([_, p]) => following.includes(p.creatorId))
                .sort((a, b) => b[1].createdAt - a[1].createdAt)
                .slice(0, 10)
                .forEach(([id, poll]) => {
                    const div = document.createElement('div');
                    div.className = 'activity-item';
                    div.textContent = `${poll.userName} created: ${poll.question}`;
                    feed.appendChild(div);
                });
        };

        App.saveDraft = async function() {
            if (!state.currentUser) return UI.showToast('Sign in to save drafts', 'error');
            const draft = {
                question: document.getElementById('pollQuestion').value.trim(),
                options: [
                    document.getElementById('option1').value.trim(),
                    document.getElementById('option2').value.trim(),
                    document.getElementById('option3').value.trim(),
                    document.getElementById('option4').value.trim()
                ].filter(opt => opt),
                tags: document.getElementById('pollTags').value.trim(),
                timer: document.getElementById('pollTimer').value.trim()
            };
            if (!draft.question || draft.options.length < 2) return;
            await db.collection('users').doc(state.currentUser.uid).collection('drafts').add(draft);
            UI.showToast('Draft saved!');
        };

        App.showDrafts = async function() {
            if (!state.currentUser) return UI.showToast('Sign in to see drafts', 'error');
            UI.showModal('draftsModal');
            const draftsList = document.getElementById('draftsList');
            draftsList.innerHTML = '';
            const snapshot = await db.collection('users').doc(state.currentUser.uid).collection('drafts').get();
            snapshot.forEach(doc => {
                const draft = doc.data();
                const div = document.createElement('div');
                div.className = 'draft-item';
                div.innerHTML = `
            <span>${draft.question}</span>
            <button onclick="App.loadDraft('${doc.id}')">Load</button>
        `;
                draftsList.appendChild(div);
            });
        };

        App.loadDraft = async function(draftId) {
            const doc = await db.collection('users').doc(state.currentUser.uid).collection('drafts').doc(draftId).get();
            const draft = doc.data();
            document.getElementById('pollQuestion').value = draft.question;
            draft.options.forEach((opt, i) => document.getElementById(`option${i + 1}`).value = opt);
            document.getElementById('pollTags').value = draft.tags || '';
            document.getElementById('pollTimer').value = draft.timer || '';
            UI.hideModals();
        };

        App.editPoll = async function(pollId) {
            const snapshot = await rtdb.ref(`polls/${pollId}`).once('value');
            const poll = snapshot.val();
            if (poll.creatorId !== state.currentUser.uid || Object.values(poll.options).some(v => v > 0)) return UI.showToast('Cannot edit', 'error');
            document.getElementById('pollQuestion').value = poll.question;
            Object.keys(poll.options).forEach((opt, i) => document.getElementById(`option${i + 1}`).value = opt);
            document.getElementById('pollTags').value = poll.tags || '';
            document.getElementById('pollTimer').value = poll.expires ? Math.ceil((poll.expires - Date.now()) / 3600000) : '';
            UI.showModal('createPollModal');
            document.getElementById('createPollModal').dataset.pollId = pollId;
        };

        App.showAnalytics = async function(pollId) {
            if (!state.currentUser) return UI.showToast('Sign in to see analytics', 'error');
            UI.showModal('analyticsModal');

            // Show a loading state while fetching data
            document.getElementById('analyticsDisplay').innerHTML = 'Loading...';

            try {
                const snapshot = await rtdb.ref(`polls/${pollId}`).once('value');
                const poll = snapshot.val();
                if (!poll) return UI.showToast('Poll not found', 'error');
                if (poll.creatorId !== state.currentUser.uid) return UI.showToast('Not your poll', 'error');

                // Calculate total votes
                const totalVotes = Object.values(poll.options).reduce((s, v) => s + v, 0);

                const formattedDate = new Date(poll.createdAt).toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                // Update the analytics display
                document.getElementById('analyticsDisplay').innerHTML = `
            Total Votes: ${totalVotes}<br>
            Created: ${formattedDate}
        `;

                // Get the canvas context
                const canvas = document.getElementById('pollChart');
                const ctx = canvas.getContext('2d');

                // Destroy any existing chart instance
                if (App.currentChart) {
                    App.currentChart.destroy();
                }

                // Create a new chart
                App.currentChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(poll.options),
                        datasets: [{
                            data: Object.values(poll.options),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Poll Results'
                            }
                        }
                    }
                });
            } catch (err) {
                UI.showToast(`Error: ${err.message}`, 'error');
                document.getElementById('analyticsDisplay').innerHTML = 'Failed to load analytics.';
            }
        };

        App.followUser = async function() {
            const username = document.getElementById('followInput').value.trim();
            if (!username) return UI.showToast('Username required', 'error');
            const userSnapshot = await db.collection('users').where('username', '==', username).get();
            if (userSnapshot.empty) return UI.showToast('User not found', 'error');
            const userId = userSnapshot.docs[0].id;
            await db.collection('users').doc(state.currentUser.uid).update({
                following: firebase.firestore.FieldValue.arrayUnion(userId)
            });
            this.loadFollowing();
        };

        App.loadFollowing = async function() {
            const followingList = document.getElementById('followingList');
            followingList.innerHTML = '';
            const following = (await db.collection('users').doc(state.currentUser.uid).get()).data().following || [];
            for (const id of following) {
                const user = (await db.collection('users').doc(id).get()).data();
                const div = document.createElement('div');
                div.className = 'follow-item';
                div.innerHTML = `<span>${user.username}</span><button onclick="App.unfollowUser('${id}')">Unfollow</button>`;
                followingList.appendChild(div);
            }
        };

        App.unfollowUser = async function(userId) {
            await db.collection('users').doc(state.currentUser.uid).update({
                following: firebase.firestore.FieldValue.arrayRemove(userId)
            });
            this.loadFollowing();
        };

        App.showFollowing = function() {
            if (!state.currentUser) return UI.showToast('Sign in to follow', 'error');
            UI.showModal('followModal');
            this.loadFollowing();
        };

        App.applyTheme = function(theme) {
            document.body.classList.remove('dark', 'blue', 'green');
            if (theme !== 'default') document.body.classList.add(theme);
            localStorage.setItem('theme', theme);
            state.darkMode = theme === 'dark';
            localStorage.setItem('darkMode', state.darkMode);
        };

        App.showArchive = async function() {
            UI.showModal('archiveModal');
            const archiveList = document.getElementById('archiveList');
            archiveList.innerHTML = '';
            const snapshot = await rtdb.ref('polls').once('value');
            const polls = snapshot.val() || {};
            Object.entries(polls)
                .filter(([_, p]) => p.expires && p.expires < Date.now())
                .forEach(([id, poll]) => {
                    const div = document.createElement('div');
                    div.textContent = `${poll.question} (Expired: ${new Date(poll.expires).toLocaleDateString()})`;
                    archiveList.appendChild(div);
                });
        };

        // Update existing renderPoll to add new options
        App.renderPollOriginal = App.renderPoll;


        App.pinPoll = function(pollId) {
            state.pinned = state.pinned || [];
            if (state.pinned.includes(pollId)) {
                state.pinned = state.pinned.filter(id => id !== pollId);
            } else {
                state.pinned.push(pollId);
            }
            localStorage.setItem('pinned', JSON.stringify(state.pinned));
            this.loadPolls();
        };

        App.updateCountdowns = function() {
            document.querySelectorAll('.countdown').forEach(span => {
                const expires = parseInt(span.dataset.expires);
                const update = () => {
                    const remaining = expires - Date.now();
                    if (remaining <= 0) {
                        span.textContent = 'Expired';
                    } else {
                        const hours = Math.floor(remaining / 3600000);
                        const minutes = Math.floor((remaining % 3600000) / 60000);
                        span.textContent = `Expires in ${hours}h ${minutes}m`;
                    }
                };
                update();
                setInterval(update, 60000);
            });
        };

        // Add badges and notifications to profile
        App.showProfileOriginal = App.showProfile;
        App.showProfile = function() {
            this.showProfileOriginal();
            const profileModal = document.getElementById('profileModal');
            profileModal.querySelector('.modal-content').innerHTML += `
        <button onclick="App.showFollowing()">Following</button>
        <button onclick="App.showActivityFeed()">Activity</button>
        <button onclick="App.showDrafts()">Drafts</button>
        <button onclick="App.showArchive()">Archive</button>
        <button onclick="App.showThemeModal()">Theme</button>
        <div id="badges"></div>
        <div id="notifications"></div>
    `;
            this.loadBadges();
            this.loadNotifications();
        };

        App.loadBadges = async function() {
            const badgesDiv = document.getElementById('badges');
            badgesDiv.innerHTML = '<h3>Badges</h3>';
            const badges = [];
            if (state.votedPolls.length >= 10) badges.push('Voter 🗳️');
            if (state.createdPolls.length >= 5) badges.push('Creator ✍️');
            badges.forEach(b => {
                const span = document.createElement('span');
                span.textContent = b;
                span.style.margin = '5px';
                badgesDiv.appendChild(span);
            });
        };

        App.loadNotifications = async function() {
            const notifsDiv = document.getElementById('notifications');
            notifsDiv.innerHTML = '<h3>Notifications</h3>';
            const following = (await db.collection('users').doc(state.currentUser.uid).get()).data().following || [];
            const snapshot = await rtdb.ref('polls').once('value');
            const polls = snapshot.val() || {};
            const newNotifs = Object.entries(polls)
                .filter(([_, p]) => following.includes(p.creatorId) && p.createdAt > (state.lastNotifCheck || 0))
                .map(([_, p]) => `${p.userName} posted: ${p.question}`);
            newNotifs.forEach(text => {
                const div = document.createElement('div');
                div.textContent = text;
                notifsDiv.appendChild(div);
            });
            state.lastNotifCheck = Date.now();
            localStorage.setItem('lastNotifCheck', state.lastNotifCheck);
        };

        App.showThemeModal = function() {
            UI.showModal('themeModal');
        };


        App.showSearchPopup = function() {
            UI.showModal('searchPopup');
            document.getElementById('searchPopupInput').value = '';
            document.getElementById('categoryPopupSelect').value = 'all';
            document.getElementById('sortPopupSelect').value = 'newest';
            document.getElementById('searchResults').innerHTML = '';
        };

        App.searchPollsFromPopup = function() {
            const query = document.getElementById('searchPopupInput').value.toLowerCase().trim();
            const filteredPolls = Object.entries(state.polls).filter(([_, poll]) =>
                poll.question.toLowerCase().includes(query) || (poll.tags && poll.tags.toLowerCase().includes(query)));
            this.renderFilteredPolls(filteredPolls, 'searchResults');
        };

        App.filterByCategoryFromPopup = function(category) {
            const query = document.getElementById('searchPopupInput').value.toLowerCase().trim();
            let filteredPolls = Object.entries(state.polls).filter(([_, poll]) =>
                poll.question.toLowerCase().includes(query) || (poll.tags && poll.tags.toLowerCase().includes(query)));
            if (category !== 'all') {
                filteredPolls = filteredPolls.filter(([_, poll]) => poll.category === category);
            }
            this.renderFilteredPolls(filteredPolls, 'searchResults');
        };

        App.sortPollsFromPopup = function(criteria) {
            const query = document.getElementById('searchPopupInput').value.toLowerCase().trim();
            let sortedPolls = Object.entries(state.polls).filter(([_, poll]) =>
                poll.question.toLowerCase().includes(query) || (poll.tags && poll.tags.toLowerCase().includes(query)));
            if (criteria === 'votes') {
                sortedPolls.sort((a, b) => Object.values(b[1].options).reduce((s, v) => s + v, 0) - Object.values(a[1].options).reduce((s, v) => s + v, 0));
            } else if (criteria === 'expiring') {
                sortedPolls.sort((a, b) => (a[1].expires || Infinity) - (b[1].expires || Infinity));
            } else {
                sortedPolls.sort((a, b) => b[1].createdAt - a[1].createdAt);
            }
            this.renderFilteredPolls(sortedPolls, 'searchResults');
        };


        // Initialize App
        App.init();
    </script>
</body>

</html>
